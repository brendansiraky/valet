---
phase: 06-output-export
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/components/output-viewer/output-viewer.tsx
  - app/components/output-viewer/download-buttons.tsx
  - app/routes/pipelines.$id.tsx
  - app/components/pipeline-runner/run-progress.tsx
autonomous: false

must_haves:
  truths:
    - "User can view the output from each agent in the pipeline"
    - "User can download the final output as a text file"
    - "User can download the final output as a markdown file"
  artifacts:
    - path: "app/components/output-viewer/output-viewer.tsx"
      provides: "Tabbed output display for pipeline results"
      exports: ["OutputViewer"]
    - path: "app/components/output-viewer/download-buttons.tsx"
      provides: "Download action buttons"
      exports: ["DownloadButtons"]
    - path: "app/routes/pipelines.$id.tsx"
      provides: "Pipeline page with output viewing integration"
      contains: "OutputViewer"
  key_links:
    - from: "app/routes/pipelines.$id.tsx"
      to: "app/components/output-viewer/output-viewer.tsx"
      via: "import and render"
      pattern: "import.*OutputViewer.*from"
    - from: "app/components/output-viewer/download-buttons.tsx"
      to: "app/lib/download.ts"
      via: "import download functions"
      pattern: "import.*download.*from.*lib/download"
    - from: "app/components/output-viewer/output-viewer.tsx"
      to: "app/components/output-viewer/markdown-viewer.tsx"
      via: "import for content rendering"
      pattern: "import.*MarkdownViewer"
---

<objective>
Create the output viewing UI and integrate it into the pipeline page.

Purpose: Allow users to view each agent's output in a tabbed interface and download the final output as text or markdown files.

Output: OutputViewer component with download buttons, integrated into the pipeline page to display results after execution completes.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-output-export/06-RESEARCH.md
@.planning/phases/06-output-export/06-01-SUMMARY.md
@app/routes/pipelines.$id.tsx
@app/components/pipeline-runner/run-progress.tsx
@app/components/pipeline-runner/use-run-stream.ts
@app/db/schema/pipeline-runs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DownloadButtons component</name>
  <files>app/components/output-viewer/download-buttons.tsx</files>
  <action>
    Create download action buttons component:

    ```typescript
    import { Button } from "~/components/ui/button";
    import { Download, FileText, FileCode } from "lucide-react";
    import { downloadTextFile, downloadMarkdownFile, sanitizeFilename } from "~/lib/download";

    interface DownloadButtonsProps {
      content: string;
      pipelineName: string;
    }

    /**
     * Download action buttons for pipeline output.
     * Provides both text (.txt) and markdown (.md) download options.
     */
    export function DownloadButtons({ content, pipelineName }: DownloadButtonsProps) {
      const baseFilename = sanitizeFilename(pipelineName) || 'pipeline-output';

      const handleDownloadText = () => {
        downloadTextFile(content, `${baseFilename}.txt`);
      };

      const handleDownloadMarkdown = () => {
        downloadMarkdownFile(content, `${baseFilename}.md`);
      };

      return (
        <div className="flex gap-2">
          <Button variant="outline" size="sm" onClick={handleDownloadText}>
            <FileText className="w-4 h-4 mr-2" />
            Download .txt
          </Button>
          <Button variant="outline" size="sm" onClick={handleDownloadMarkdown}>
            <FileCode className="w-4 h-4 mr-2" />
            Download .md
          </Button>
        </div>
      );
    }
    ```
  </action>
  <verify>
    - File exists at app/components/output-viewer/download-buttons.tsx
    - Imports download utilities from ~/lib/download
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>DownloadButtons component provides text and markdown download actions</done>
</task>

<task type="auto">
  <name>Task 2: Create OutputViewer component</name>
  <files>app/components/output-viewer/output-viewer.tsx</files>
  <action>
    Create tabbed output viewer showing each agent's output:

    ```typescript
    import { Tabs, TabsContent, TabsList, TabsTrigger } from "~/components/ui/tabs";
    import { Card, CardContent, CardHeader, CardTitle } from "~/components/ui/card";
    import { ScrollArea } from "~/components/ui/scroll-area";
    import { MarkdownViewer } from "./markdown-viewer";
    import { DownloadButtons } from "./download-buttons";

    interface StepOutput {
      agentName: string;
      output: string;
    }

    interface OutputViewerProps {
      steps: StepOutput[];
      finalOutput: string;
      pipelineName: string;
      onClose?: () => void;
    }

    /**
     * Tabbed output viewer for pipeline execution results.
     * Shows each agent's output in separate tabs with a final output tab.
     * Includes download buttons for the final output.
     */
    export function OutputViewer({
      steps,
      finalOutput,
      pipelineName,
      onClose,
    }: OutputViewerProps) {
      const defaultTab = steps.length > 0 ? "final" : "step-0";

      return (
        <Card className="w-full">
          <CardHeader className="pb-3">
            <div className="flex items-center justify-between">
              <CardTitle className="text-lg">Pipeline Output</CardTitle>
              <DownloadButtons content={finalOutput} pipelineName={pipelineName} />
            </div>
          </CardHeader>
          <CardContent>
            <Tabs defaultValue={defaultTab}>
              <TabsList className="mb-4">
                {steps.map((step, index) => (
                  <TabsTrigger key={index} value={`step-${index}`}>
                    {step.agentName}
                  </TabsTrigger>
                ))}
                <TabsTrigger value="final">Final Output</TabsTrigger>
              </TabsList>

              {steps.map((step, index) => (
                <TabsContent key={index} value={`step-${index}`}>
                  <ScrollArea className="h-[400px] rounded-md border p-4">
                    <MarkdownViewer content={step.output || "No output"} />
                  </ScrollArea>
                </TabsContent>
              ))}

              <TabsContent value="final">
                <ScrollArea className="h-[400px] rounded-md border p-4">
                  <MarkdownViewer content={finalOutput || "No output"} />
                </ScrollArea>
              </TabsContent>
            </Tabs>

            {onClose && (
              <div className="flex justify-end mt-4">
                <Button variant="outline" onClick={onClose}>
                  Close
                </Button>
              </div>
            )}
          </CardContent>
        </Card>
      );
    }
    ```

    Note: Import Button at the top if onClose is used. The optional onClose allows dismissing the viewer.
  </action>
  <verify>
    - File exists at app/components/output-viewer/output-viewer.tsx
    - Imports Tabs from ~/components/ui/tabs
    - Imports MarkdownViewer and DownloadButtons
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>OutputViewer displays tabbed output with markdown rendering and download buttons</done>
</task>

<task type="auto">
  <name>Task 3: Integrate OutputViewer into pipeline page</name>
  <files>app/routes/pipelines.$id.tsx, app/components/pipeline-runner/run-progress.tsx</files>
  <action>
    Update the pipeline page to show OutputViewer after execution completes:

    1. In pipelines.$id.tsx, add state for completed run output:
       ```typescript
       const [completedOutput, setCompletedOutput] = useState<{
         steps: Array<{ agentName: string; output: string }>;
         finalOutput: string;
       } | null>(null);
       ```

    2. Update handleRunComplete to store the output data:
       ```typescript
       const handleRunComplete = useCallback((finalOutput: string, stepOutputs: Map<number, string>) => {
         // Convert stepOutputs map to array with agent names
         const steps = pipelineSteps.map((step, index) => ({
           agentName: step.agentName,
           output: stepOutputs.get(index) || "",
         }));

         setCompletedOutput({ steps, finalOutput });
         setCurrentRunId(null);
       }, [pipelineSteps]);
       ```

    3. Update RunProgress component to pass stepOutputs to onComplete:
       In run-progress.tsx, modify the useEffect that calls onComplete:
       ```typescript
       useEffect(() => {
         if (status === "completed" && finalOutput && onComplete) {
           onComplete(finalOutput, stepOutputs);
         }
         // ... error handling
       }, [status, finalOutput, stepOutputs, error, onComplete, onError]);
       ```

       Update the onComplete prop type:
       ```typescript
       onComplete?: (finalOutput: string, stepOutputs: Map<number, string>) => void;
       ```

    4. Add OutputViewer rendering in the pipeline page:
       ```typescript
       import { OutputViewer } from "~/components/output-viewer/output-viewer";

       // In the return JSX, after the Run Progress section:
       {completedOutput && (
         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
           <div className="w-full max-w-4xl mx-4">
             <OutputViewer
               steps={completedOutput.steps}
               finalOutput={completedOutput.finalOutput}
               pipelineName={pipelineName}
               onClose={() => setCompletedOutput(null)}
             />
           </div>
         </div>
       )}
       ```

    5. Import Button in output-viewer.tsx if not already imported (needed for onClose).
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit`
    - Dev server runs: `npm run dev`
    - OutputViewer import exists in pipelines.$id.tsx
    - RunProgress onComplete signature updated to include stepOutputs
  </verify>
  <done>Pipeline page displays OutputViewer modal when execution completes</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete output viewing and download functionality:
    - Tabbed output viewer showing each agent's output
    - Markdown rendering with proper typography
    - Download buttons for .txt and .md files
    - Modal display after pipeline execution completes
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Navigate to http://localhost:5173 and log in
    3. Open an existing pipeline with agents (or create one with 2-3 agents)
    4. Click "Run" to execute the pipeline
    5. Wait for execution to complete
    6. Verify the output modal appears with:
       - Tabs for each agent's output (click through to see individual outputs)
       - "Final Output" tab showing the last agent's output
       - Markdown rendered properly (headings, lists, etc. if present)
       - Download buttons visible in the header

    7. Test downloads:
       - Click "Download .txt" - should download a .txt file
       - Click "Download .md" - should download a .md file
       - Open downloaded files to verify content matches final output

    8. Test modal:
       - Click "Close" button - modal should dismiss
       - Verify pipeline canvas is still visible and usable

    9. Test dark mode (if applicable):
       - Toggle dark mode
       - Verify markdown text remains readable (prose-invert styling)
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles without errors:
   ```bash
   npx tsc --noEmit
   ```

2. Dev server runs without errors:
   ```bash
   npm run dev
   ```

3. Functional verification via checkpoint task
</verification>

<success_criteria>
- OutputViewer component displays tabs for each agent output
- MarkdownViewer renders content with prose typography
- Download buttons generate and trigger file downloads
- Downloads use sanitized filename based on pipeline name
- Pipeline page shows output modal after execution completes
- Modal can be closed to return to canvas
- Dark mode compatibility maintained
</success_criteria>

<output>
After completion, create `.planning/phases/06-output-export/06-02-SUMMARY.md`
</output>
