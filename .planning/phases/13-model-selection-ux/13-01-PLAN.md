---
phase: 13-model-selection-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/model-selector.tsx
  - app/routes/agents.tsx
  - app/components/agent-form-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Agent form shows models grouped by provider (Anthropic, OpenAI)"
    - "Only models for providers with configured API keys are visible"
    - "User can select 'Use default from settings' option"
    - "User can select any model from available providers"
  artifacts:
    - path: "app/components/model-selector.tsx"
      provides: "Reusable grouped model dropdown component"
      exports: ["ModelSelector"]
    - path: "app/routes/agents.tsx"
      provides: "configuredProviders in loader data"
      contains: "configuredProviders"
    - path: "app/components/agent-form-dialog.tsx"
      provides: "Agent form using ModelSelector"
      contains: "ModelSelector"
  key_links:
    - from: "app/components/agent-form-dialog.tsx"
      to: "app/components/model-selector.tsx"
      via: "ModelSelector import and usage"
      pattern: "import.*ModelSelector"
    - from: "app/routes/agents.tsx"
      to: "app/components/agent-form-dialog.tsx"
      via: "configuredProviders prop"
      pattern: "configuredProviders"
---

<objective>
Create a reusable ModelSelector component with provider grouping and integrate it into the agent form.

Purpose: Users need to see models organized by provider and only see models for providers they have configured, preventing runtime errors when selecting unavailable models.

Output: ModelSelector component and updated agent form that filters models by configured providers.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/lib/models.ts
@app/components/ui/select.tsx
@app/routes/agents.tsx
@app/components/agent-form-dialog.tsx
@app/db/schema/api-keys.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModelSelector component</name>
  <files>app/components/model-selector.tsx</files>
  <action>
Create a new ModelSelector component that:

1. Accepts props:
   - `name: string` - form field name
   - `defaultValue?: string` - selected model ID or "__default__"
   - `configuredProviders: string[]` - array like ["anthropic", "openai"]
   - `showDefault?: boolean` - whether to show "Use default from settings" option (default true)

2. Uses SelectGroup and SelectLabel from shadcn/ui select to group models by provider

3. Structure:
```tsx
import { ANTHROPIC_MODELS, OPENAI_MODELS } from "~/lib/models";
import {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectTrigger,
  SelectValue,
} from "~/components/ui/select";

interface ModelSelectorProps {
  name: string;
  defaultValue?: string;
  configuredProviders: string[];
  showDefault?: boolean;
}

export function ModelSelector({
  name,
  defaultValue,
  configuredProviders,
  showDefault = true,
}: ModelSelectorProps) {
  const hasAnthropic = configuredProviders.includes("anthropic");
  const hasOpenAI = configuredProviders.includes("openai");

  // Empty state: no providers configured
  if (!hasAnthropic && !hasOpenAI) {
    return (
      <Select disabled name={name}>
        <SelectTrigger className="w-full">
          <SelectValue placeholder="Configure API keys in Settings" />
        </SelectTrigger>
      </Select>
    );
  }

  return (
    <Select name={name} defaultValue={defaultValue ?? (showDefault ? "__default__" : undefined)}>
      <SelectTrigger className="w-full">
        <SelectValue placeholder="Select a model" />
      </SelectTrigger>
      <SelectContent>
        {showDefault && (
          <SelectItem value="__default__">Use default from settings</SelectItem>
        )}

        {hasAnthropic && (
          <SelectGroup>
            <SelectLabel>Anthropic</SelectLabel>
            {ANTHROPIC_MODELS.map((model) => (
              <SelectItem key={model.id} value={model.id}>
                {model.name}
              </SelectItem>
            ))}
          </SelectGroup>
        )}

        {hasOpenAI && (
          <SelectGroup>
            <SelectLabel>OpenAI</SelectLabel>
            {OPENAI_MODELS.map((model) => (
              <SelectItem key={model.id} value={model.id}>
                {model.name}
              </SelectItem>
            ))}
          </SelectGroup>
        )}
      </SelectContent>
    </Select>
  );
}
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>ModelSelector component exists with grouped provider sections and empty state handling</done>
</task>

<task type="auto">
  <name>Task 2: Add configuredProviders to agents loader and update AgentFormDialog</name>
  <files>app/routes/agents.tsx, app/components/agent-form-dialog.tsx</files>
  <action>
**In app/routes/agents.tsx:**

1. Import apiKeys from db:
```tsx
import { db, users, agents, agentTraits, traits, apiKeys } from "~/db";
```

2. In loader, after verifying user exists, query configured providers:
```tsx
// Query user's configured providers
const userApiKeys = await db.query.apiKeys.findMany({
  where: eq(apiKeys.userId, userId),
  columns: { provider: true },
});
const configuredProviders = userApiKeys.map((k) => k.provider);
```

3. Return configuredProviders in loader data:
```tsx
return { agents: agentsWithTraitIds, traits: userTraits, configuredProviders };
```

4. Pass configuredProviders to AgentFormDialog components:
```tsx
<AgentFormDialog
  traits={userTraits}
  configuredProviders={configuredProviders}
  trigger={...}
/>
```

**In app/components/agent-form-dialog.tsx:**

1. Update imports - remove ALL_MODELS, add ModelSelector:
```tsx
// Remove: import { ALL_MODELS } from "~/lib/models";
import { ModelSelector } from "~/components/model-selector";
```

2. Update interface to accept configuredProviders:
```tsx
interface AgentFormDialogProps {
  agent?: Pick<Agent, "id" | "name" | "instructions"> & {
    model?: string | null;
    traitIds?: string[];
  };
  traits?: Array<{ id: string; name: string }>;
  configuredProviders: string[];
  trigger: ReactNode;
}
```

3. Update component signature:
```tsx
export function AgentFormDialog({ agent, traits, configuredProviders, trigger }: AgentFormDialogProps) {
```

4. Replace the model Select with ModelSelector:

Find this block:
```tsx
<div className="space-y-2">
  <Label htmlFor="model">Model</Label>
  <Select name="model" defaultValue={agent?.model ?? "__default__"}>
    <SelectTrigger id="model" className="w-full">
      <SelectValue placeholder="Use default from settings" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="__default__">Use default from settings</SelectItem>
      {ALL_MODELS.map((model) => (
        <SelectItem key={model.id} value={model.id}>
          {model.name}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
  <p className="text-xs text-muted-foreground">
    Override the default model for this agent.
  </p>
</div>
```

Replace with:
```tsx
<div className="space-y-2">
  <Label htmlFor="model">Model</Label>
  <ModelSelector
    name="model"
    defaultValue={agent?.model ?? "__default__"}
    configuredProviders={configuredProviders}
  />
  <p className="text-xs text-muted-foreground">
    Override the default model for this agent.
  </p>
</div>
```

5. Clean up unused imports (Select, SelectContent, SelectItem, SelectTrigger, SelectValue if not used elsewhere in the file).
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Open http://localhost:5173/agents and verify model dropdown shows grouped models
3. If only Anthropic key configured, only Anthropic models should show
  </verify>
  <done>
- Agents loader returns configuredProviders array
- AgentFormDialog accepts and uses configuredProviders prop
- Model dropdown shows models grouped by provider with labels
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Visit /agents page - model dropdown in agent form shows grouped models
3. If only Anthropic key is configured: only Anthropic section visible
4. If both keys configured: both Anthropic and OpenAI sections visible
5. "Use default from settings" option appears at top
6. Creating/editing agent with selected model works correctly
</verification>

<success_criteria>
- ModelSelector component created with provider grouping
- Agent form uses ModelSelector with configuredProviders
- Models filtered by user's configured API keys
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-model-selection-ux/13-01-SUMMARY.md`
</output>
