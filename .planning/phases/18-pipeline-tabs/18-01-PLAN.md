---
phase: 18-pipeline-tabs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/stores/tab-store.ts
  - app/stores/pipeline-store.ts
autonomous: true

must_haves:
  truths:
    - "Tab state persists across browser refresh"
    - "Multiple pipelines can have independent state simultaneously"
    - "Opening duplicate tab focuses existing instead of creating new"
    - "Maximum 8 tabs enforced"
  artifacts:
    - path: "app/stores/tab-store.ts"
      provides: "Tab management with localStorage persistence"
      exports: ["useTabStore", "Tab"]
    - path: "app/stores/pipeline-store.ts"
      provides: "Multi-pipeline state keyed by pipeline ID"
      exports: ["usePipelineStore", "PipelineData"]
  key_links:
    - from: "app/stores/tab-store.ts"
      to: "localStorage"
      via: "Zustand persist middleware"
      pattern: "persist\\("
---

<objective>
Create the foundational stores for multi-tab pipeline editing.

Purpose: Tab store manages which pipelines are open and active. Pipeline store refactored to support multiple simultaneous pipelines keyed by ID.

Output: Two Zustand stores providing tab management and multi-pipeline state.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-pipeline-tabs/18-RESEARCH.md

@app/stores/pipeline-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tab store with localStorage persistence</name>
  <files>app/stores/tab-store.ts</files>
  <action>
Create a new Zustand store for managing pipeline tabs.

Structure:
```typescript
interface Tab {
  pipelineId: string;
  name: string;
}

interface TabState {
  tabs: Tab[];
  activeTabId: string | null;

  openTab: (pipelineId: string, name: string) => void;
  closeTab: (pipelineId: string) => void;
  setActiveTab: (pipelineId: string) => void;
  focusOrOpenTab: (pipelineId: string, name: string) => void;
  updateTabName: (pipelineId: string, name: string) => void;
  canOpenNewTab: () => boolean;
}
```

Key behaviors:
- `openTab`: Add tab if under 8 limit, set as active. If already open, focus instead.
- `closeTab`: Remove tab, if was active set next tab active (or null if none left).
- `focusOrOpenTab`: Open if not exists, focus if exists (for duplicate prevention).
- `canOpenNewTab`: Returns false if tabs.length >= 8.
- `updateTabName`: Update name for a tab (for autosave sync).

Use Zustand persist middleware with localStorage:
```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

export const useTabStore = create<TabState>()(
  persist(
    (set, get) => ({
      // ... implementation
    }),
    {
      name: 'valet-pipeline-tabs',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        tabs: state.tabs,
        activeTabId: state.activeTabId,
      }),
    }
  )
);
```

Export both the store hook and the Tab type.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Tab store exists with persistence, openTab respects 8 tab limit, focusOrOpenTab prevents duplicates</done>
</task>

<task type="auto">
  <name>Task 2: Refactor pipeline store to multi-pipeline state</name>
  <files>app/stores/pipeline-store.ts</files>
  <action>
Refactor the existing single-pipeline store to support multiple pipelines simultaneously.

New structure:
```typescript
interface PipelineData {
  pipelineId: string;
  pipelineName: string;
  pipelineDescription: string;
  nodes: Node<PipelineNodeData>[];
  edges: Edge[];
  isDirty: boolean; // Track unsaved changes for autosave
}

interface PipelineState {
  pipelines: Map<string, PipelineData>;

  // Per-pipeline actions
  loadPipeline: (data: PipelineData) => void;
  updatePipeline: (id: string, updates: Partial<Omit<PipelineData, 'pipelineId'>>) => void;
  removePipeline: (id: string) => void;
  getPipeline: (id: string) => PipelineData | undefined;
  markDirty: (id: string) => void;
  markClean: (id: string) => void;

  // React Flow callbacks factory (returns callbacks scoped to pipeline ID)
  createOnNodesChange: (pipelineId: string) => OnNodesChange<Node<PipelineNodeData>>;
  createOnEdgesChange: (pipelineId: string) => OnEdgesChange;
  createOnConnect: (pipelineId: string) => OnConnect;

  // Node manipulation (scoped by pipeline ID)
  addAgentNode: (pipelineId: string, agent: { id: string; name: string; instructions?: string }, position: { x: number; y: number }) => void;
  addTraitNode: (pipelineId: string, trait: { id: string; name: string; color: string }, position: { x: number; y: number }) => void;
  removeNode: (pipelineId: string, nodeId: string) => void;
  addTraitToNode: (pipelineId: string, nodeId: string, traitId: string) => void;
  removeTraitFromNode: (pipelineId: string, nodeId: string, traitId: string) => void;
}
```

Key changes:
- Store uses `Map<string, PipelineData>` instead of flat state
- All node/edge operations take `pipelineId` as first argument
- `createOnNodesChange`, `createOnEdgesChange`, `createOnConnect` return callbacks curried with pipeline ID
- Each change sets `isDirty: true` for that pipeline
- Keep existing type exports (AgentNodeData, TraitNodeData, PipelineNodeData)

Remove the old single-pipeline fields (pipelineId, pipelineName, etc.) and reset() action.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>Pipeline store supports multiple pipelines keyed by ID, all mutations set isDirty flag</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Tab store persists to localStorage (check DevTools Application > Local Storage)
3. Tab store enforces 8 tab max
4. Pipeline store can hold multiple pipelines simultaneously
</verification>

<success_criteria>
- Tab store created with Zustand persist middleware
- Pipeline store refactored to Map-based multi-pipeline state
- All operations scoped by pipeline ID
- isDirty flag tracking in pipeline store
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/18-pipeline-tabs/18-01-SUMMARY.md`
</output>
