---
phase: 18-pipeline-tabs
plan: 04
type: execute
wave: 3
depends_on: ["18-02", "18-03"]
files_modified:
  - app/components/pipeline-builder/pipeline-tabs.tsx
  - app/routes/pipelines.tsx
  - app/components/pipeline-card.tsx
autonomous: true

must_haves:
  truths:
    - "Closing tab with active run shows confirmation warning"
    - "Clicking pipeline in list opens it as tab (not full navigation)"
    - "User sees helpful message when 8 tab limit reached"
  artifacts:
    - path: "app/components/pipeline-builder/pipeline-tabs.tsx"
      provides: "Tab close with running pipeline confirmation"
      contains: "AlertDialog"
    - path: "app/components/pipeline-card.tsx"
      provides: "Opens pipeline in tab instead of navigation"
      contains: "focusOrOpenTab"
  key_links:
    - from: "app/routes/pipelines.tsx"
      to: "app/stores/tab-store.ts"
      via: "tab store for opening pipelines"
      pattern: "useTabStore"
---

<objective>
Add running pipeline warning and integrate tabs with pipelines list.

Purpose: Prevent accidental loss of running pipeline progress. Make opening pipelines from the list use the tab system.

Output: Confirmation dialog on close, tab-aware pipeline list.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/18-pipeline-tabs/18-RESEARCH.md
@.planning/phases/18-pipeline-tabs/18-02-SUMMARY.md
@.planning/phases/18-pipeline-tabs/18-03-SUMMARY.md

@app/components/pipeline-builder/pipeline-tabs.tsx
@app/routes/pipelines.tsx
@app/components/pipeline-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add running pipeline close confirmation</name>
  <files>app/components/pipeline-builder/pipeline-tabs.tsx</files>
  <action>
Update the tab bar to check for running pipelines before closing and show a confirmation dialog.

Changes:
1. Accept `runStates` prop (Map of pipelineId to run state)
2. When closing a tab with active run, show AlertDialog confirmation
3. Allow force close from dialog

```typescript
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '~/components/ui/alert-dialog';

interface PipelineTabsProps {
  runStates: Map<string, { runId: string | null; isStarting: boolean }>;
  onCloseTab: (pipelineId: string) => void;
}

export function PipelineTabs({ runStates, onCloseTab }: PipelineTabsProps) {
  const navigate = useNavigate();
  const { tabs, activeTabId, closeTab, canOpenNewTab } = useTabStore();
  const [confirmCloseId, setConfirmCloseId] = useState<string | null>(null);

  const handleClose = (e: React.MouseEvent, pipelineId: string) => {
    e.stopPropagation();

    // Check if pipeline is running
    const runState = runStates.get(pipelineId);
    const isRunning = runState?.runId || runState?.isStarting;

    if (isRunning) {
      setConfirmCloseId(pipelineId);
      return;
    }

    performClose(pipelineId);
  };

  const performClose = (pipelineId: string) => {
    onCloseTab(pipelineId); // Parent cleanup
    closeTab(pipelineId);

    // Navigate to remaining tab or pipelines list
    const remaining = tabs.filter(t => t.pipelineId !== pipelineId);
    if (remaining.length > 0) {
      const lastTab = remaining[remaining.length - 1];
      navigate(`/pipelines/${lastTab.pipelineId}`);
    } else {
      navigate('/pipelines');
    }

    setConfirmCloseId(null);
  };

  // ... rest of component

  return (
    <>
      <div className="flex items-center border-b bg-muted/30 px-2 h-10">
        {/* tabs */}
      </div>

      <AlertDialog open={!!confirmCloseId} onOpenChange={(open) => !open && setConfirmCloseId(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Close running pipeline?</AlertDialogTitle>
            <AlertDialogDescription>
              This pipeline is currently running. Closing it will stop the run and you may lose progress.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
              onClick={() => confirmCloseId && performClose(confirmCloseId)}
            >
              Close Anyway
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
```

Update the route (pipelines.$id.tsx) to pass runStates and onCloseTab props to PipelineTabs.
  </action>
  <verify>Try closing a tab while pipeline is running - confirmation appears</verify>
  <done>Closing running pipeline tab shows warning, allows cancel or force close</done>
</task>

<task type="auto">
  <name>Task 2: Update pipeline card to open in tab</name>
  <files>app/components/pipeline-card.tsx</files>
  <action>
Update the pipeline card component to use the tab store instead of direct navigation.

Changes:
1. Import and use `useTabStore`
2. On click, use `focusOrOpenTab` instead of `<Link>`
3. Show toast if 8 tab limit reached
4. Still navigate to update URL

```typescript
import { useNavigate } from 'react-router';
import { useTabStore } from '~/stores/tab-store';
import { toast } from 'sonner';

export function PipelineCard({ pipeline }: PipelineCardProps) {
  const navigate = useNavigate();
  const { focusOrOpenTab, canOpenNewTab, tabs } = useTabStore();

  const handleClick = (e: React.MouseEvent) => {
    e.preventDefault();

    // Check if already open
    const isAlreadyOpen = tabs.some(t => t.pipelineId === pipeline.id);

    if (!isAlreadyOpen && !canOpenNewTab()) {
      toast.error('Maximum 8 tabs open. Close a tab to open another.');
      return;
    }

    focusOrOpenTab(pipeline.id, pipeline.name);
    navigate(`/pipelines/${pipeline.id}`);
  };

  return (
    <Card
      className="cursor-pointer hover:bg-muted/50 transition-colors"
      onClick={handleClick}
    >
      {/* existing card content */}
    </Card>
  );
}
```

The card should be clickable (not wrapped in Link) and handle the tab logic.
  </action>
  <verify>Click pipeline card - opens in tab, doesn't exceed 8 tabs</verify>
  <done>Pipeline cards open pipelines as tabs, respect 8 tab limit with toast message</done>
</task>

<task type="auto">
  <name>Task 3: Update pipelines list route for tab integration</name>
  <files>app/routes/pipelines.tsx</files>
  <action>
Minor updates to the pipelines list route:

1. The "New Pipeline" button should use the same tab-aware approach
2. Update the empty state "Create your first pipeline" button similarly

```typescript
import { useNavigate } from 'react-router';
import { useTabStore } from '~/stores/tab-store';
import { toast } from 'sonner';

export default function PipelinesPage() {
  const { pipelines: userPipelines } = useLoaderData<typeof loader>();
  const navigate = useNavigate();
  const { canOpenNewTab } = useTabStore();

  const handleNewPipeline = async () => {
    if (!canOpenNewTab()) {
      toast.error('Maximum 8 tabs open. Close a tab to create a new pipeline.');
      return;
    }

    // Create new pipeline in DB
    const formData = new FormData();
    formData.set('intent', 'create');
    formData.set('name', 'Untitled Pipeline');
    formData.set('flowData', JSON.stringify({ nodes: [], edges: [] }));

    const response = await fetch('/api/pipelines', {
      method: 'POST',
      body: formData,
    });

    const { pipeline } = await response.json();
    navigate(`/pipelines/${pipeline.id}`);
  };

  return (
    <div className="container mx-auto px-4 py-8 sm:px-6 lg:px-8">
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-2xl font-semibold">Pipelines</h1>
          <p className="text-muted-foreground">
            Create and manage your agent pipelines
          </p>
        </div>
        <Button onClick={handleNewPipeline}>
          <Plus className="size-4 mr-2" />
          New Pipeline
        </Button>
      </div>

      {userPipelines.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center">
            <p className="text-muted-foreground mb-4">
              You haven't created any pipelines yet.
            </p>
            <Button onClick={handleNewPipeline}>
              Create your first pipeline
            </Button>
          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {userPipelines.map((pipeline) => (
            <PipelineCard key={pipeline.id} pipeline={pipeline} />
          ))}
        </div>
      )}
    </div>
  );
}
```

Remove the `asChild` and `<Link>` patterns, use onClick handlers that respect tab limits.
  </action>
  <verify>New Pipeline button creates pipeline and opens as tab, respects limit</verify>
  <done>Pipelines list fully integrated with tab system, all creation paths respect 8 tab limit</done>
</task>

</tasks>

<verification>
1. Close tab with running pipeline - confirmation dialog appears
2. Confirm close - tab closes, run state cleaned up
3. Click pipeline in list with <8 tabs - opens as tab
4. Try opening 9th pipeline - toast error appears
5. New Pipeline button with 8 tabs - toast error appears
6. All success criteria from phase scope met
</verification>

<success_criteria>
- Running pipeline close confirmation works
- Pipeline cards open via tab system
- 8 tab limit enforced with user-friendly messages
- New Pipeline button uses tab system
- All phase success criteria can be verified
</success_criteria>

<output>
After completion, create `.planning/phases/18-pipeline-tabs/18-04-SUMMARY.md`
</output>
