---
phase: 03-agent-capabilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/agent-runner.server.ts
  - app/services/capabilities/text-generation.server.ts
autonomous: true

must_haves:
  truths:
    - "Agent runner orchestrates execution of agent with user input"
    - "Text generation capability calls Anthropic API with agent instructions"
    - "Response includes text content blocks from Claude"
  artifacts:
    - path: "app/services/agent-runner.server.ts"
      provides: "Agent execution orchestration"
      exports: ["runAgent", "AgentRunResult"]
    - path: "app/services/capabilities/text-generation.server.ts"
      provides: "Text generation via Anthropic API"
      exports: ["generateText", "TextGenerationParams"]
  key_links:
    - from: "app/services/agent-runner.server.ts"
      to: "app/services/capabilities/text-generation.server.ts"
      via: "import and call generateText"
      pattern: "import.*generateText.*from.*text-generation"
    - from: "app/services/capabilities/text-generation.server.ts"
      to: "app/services/anthropic.server.ts"
      via: "uses Anthropic client"
      pattern: "client\\.messages\\.create"
---

<objective>
Create the agent runner service and text generation capability (CAPS-01).

Purpose: Establishes the core execution infrastructure that all agent capabilities build upon. Text generation is the foundational capability - agents that can respond via LLM.

Output:
- Agent runner service that orchestrates agent execution
- Text generation capability that calls Anthropic API with agent instructions
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-agent-capabilities/03-RESEARCH.md
@app/services/anthropic.server.ts
@app/lib/models.ts
@app/db/schema/agents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create text generation capability service</name>
  <files>app/services/capabilities/text-generation.server.ts</files>
  <action>
Create the text generation capability module following the pattern from RESEARCH.md.

```typescript
// app/services/capabilities/text-generation.server.ts
import Anthropic from "@anthropic-ai/sdk";
import type { MessageParam } from "@anthropic-ai/sdk/resources/messages";

export interface TextGenerationParams {
  client: Anthropic;
  model: string;
  systemPrompt: string;
  messages: MessageParam[];
  maxTokens?: number;
}

export interface TextGenerationResult {
  content: string;
  stopReason: string | null;
  usage: {
    inputTokens: number;
    outputTokens: number;
  };
}

export async function generateText(params: TextGenerationParams): Promise<TextGenerationResult>
```

Implementation:
- Call `client.messages.create()` with model, max_tokens, system, messages
- Extract text content from response.content array (filter for type === "text")
- Return combined text, stop_reason, and token usage
- Default maxTokens to 4096
- Handle the content array properly - concatenate all text blocks
  </action>
  <verify>TypeScript compiles: `npm run typecheck`</verify>
  <done>TextGenerationParams, TextGenerationResult types exported. generateText function calls Anthropic API and returns structured result.</done>
</task>

<task type="auto">
  <name>Task 2: Create agent runner service</name>
  <files>app/services/agent-runner.server.ts</files>
  <action>
Create the agent runner that orchestrates agent execution.

```typescript
// app/services/agent-runner.server.ts
import type { Agent } from "~/db/schema/agents";
import type { ModelId } from "~/lib/models";
import { createAnthropicClient } from "./anthropic.server";
import { generateText, type TextGenerationResult } from "./capabilities/text-generation.server";

export interface AgentRunParams {
  agent: Agent;
  userInput: string;
  encryptedApiKey: string;
  model: ModelId;
}

export interface AgentRunResult {
  success: boolean;
  content?: string;
  error?: string;
  usage?: {
    inputTokens: number;
    outputTokens: number;
  };
}

export async function runAgent(params: AgentRunParams): Promise<AgentRunResult>
```

Implementation:
- Create Anthropic client from encrypted API key using createAnthropicClient
- Build system prompt from agent.instructions
- Create messages array with user input as first message
- Call generateText with the client, model, system prompt, messages
- Wrap in try/catch, return success: false with error message on failure
- Return AgentRunResult with content and usage on success
  </action>
  <verify>TypeScript compiles: `npm run typecheck`</verify>
  <done>runAgent function accepts agent, user input, API key, model and returns execution result with content or error.</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes with no errors
- Both files export their types and functions
- Agent runner imports and uses text generation capability
</verification>

<success_criteria>
- Agent runner service orchestrates execution with proper error handling
- Text generation capability calls Anthropic API correctly
- Types are exported for use by route handlers
- No runtime dependencies on UI - pure server-side services
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-capabilities/03-01-SUMMARY.md`
</output>
