---
phase: 03-agent-capabilities
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/services/capabilities/web-search.server.ts
  - app/services/capabilities/url-fetch.server.ts
  - app/services/agent-runner.server.ts
autonomous: true

must_haves:
  truths:
    - "Agent can perform web searches via Anthropic built-in tool"
    - "Agent can fetch URL content via Anthropic built-in tool"
    - "Agent runner supports optional capability flags"
  artifacts:
    - path: "app/services/capabilities/web-search.server.ts"
      provides: "Web search via Anthropic web_search_20250305"
      exports: ["runWithWebSearch", "WebSearchResult"]
    - path: "app/services/capabilities/url-fetch.server.ts"
      provides: "URL fetch via Anthropic web_fetch_20250910"
      exports: ["runWithUrlFetch", "UrlFetchResult"]
  key_links:
    - from: "app/services/capabilities/web-search.server.ts"
      to: "app/services/anthropic.server.ts"
      via: "uses Anthropic client with web_search tool"
      pattern: "type.*web_search_20250305"
    - from: "app/services/capabilities/url-fetch.server.ts"
      to: "app/services/anthropic.server.ts"
      via: "uses Anthropic client with web_fetch tool and beta header"
      pattern: "anthropic-beta.*web-fetch"
---

<objective>
Add web search (CAPS-02) and URL fetch (CAPS-03) capabilities using Anthropic's built-in tools.

Purpose: Enables agents to research topics via web search and read specific URLs. These capabilities use Anthropic's server-side tools, eliminating need for third-party APIs.

Output:
- Web search capability using web_search_20250305 tool
- URL fetch capability using web_fetch_20250910 tool (with beta header)
- Updated agent runner with capability flags
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-agent-capabilities/03-RESEARCH.md
@.planning/phases/03-agent-capabilities/03-01-SUMMARY.md
@app/services/anthropic.server.ts
@app/services/agent-runner.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create web search capability</name>
  <files>app/services/capabilities/web-search.server.ts</files>
  <action>
Create web search capability using Anthropic's built-in web_search tool.

```typescript
// app/services/capabilities/web-search.server.ts
import Anthropic from "@anthropic-ai/sdk";

export interface WebSearchParams {
  client: Anthropic;
  model: string;
  systemPrompt: string;
  userInput: string;
  maxSearches?: number;  // max_uses for web_search tool, default 5
  maxTokens?: number;
}

export interface WebSearchResult {
  content: string;
  citations: Array<{
    url: string;
    title?: string;
  }>;
  usage: {
    inputTokens: number;
    outputTokens: number;
  };
}

export async function runWithWebSearch(params: WebSearchParams): Promise<WebSearchResult>
```

Implementation per RESEARCH.md:
- Add web_search_20250305 tool to request:
  ```typescript
  tools: [{
    type: "web_search_20250305",
    name: "web_search",
    max_uses: maxSearches ?? 5,
  }]
  ```
- Call client.messages.create() with tools array
- Parse response.content array:
  - Extract text from blocks where type === "text"
  - Extract citations from text blocks that have citations property
- Handle web_search_tool_result blocks (check for errors)
- Return combined content, citations array, and usage
  </action>
  <verify>TypeScript compiles: `npm run typecheck`</verify>
  <done>runWithWebSearch function enables Claude to search the web and returns results with citations.</done>
</task>

<task type="auto">
  <name>Task 2: Create URL fetch capability</name>
  <files>app/services/capabilities/url-fetch.server.ts</files>
  <action>
Create URL fetch capability using Anthropic's built-in web_fetch tool.

CRITICAL: web_fetch is in beta and requires the header `anthropic-beta: web-fetch-2025-09-10`

```typescript
// app/services/capabilities/url-fetch.server.ts
import Anthropic from "@anthropic-ai/sdk";

export interface UrlFetchParams {
  client: Anthropic;
  model: string;
  systemPrompt: string;
  userInput: string;  // Must contain the URL(s) to fetch
  maxFetches?: number;       // max_uses for web_fetch tool, default 5
  maxContentTokens?: number; // Per RESEARCH.md, suggest 25000
  maxTokens?: number;
}

export interface UrlFetchResult {
  content: string;
  citations: Array<{
    url: string;
    title?: string;
  }>;
  usage: {
    inputTokens: number;
    outputTokens: number;
  };
}

export async function runWithUrlFetch(params: UrlFetchParams): Promise<UrlFetchResult>
```

Implementation per RESEARCH.md:
- Add web_fetch_20250910 tool with citations enabled:
  ```typescript
  tools: [{
    type: "web_fetch_20250910",
    name: "web_fetch",
    max_uses: maxFetches ?? 5,
    max_content_tokens: maxContentTokens ?? 25000,
    citations: { enabled: true },
  }]
  ```
- MUST pass beta header in request options:
  ```typescript
  await client.messages.create({...}, {
    headers: { "anthropic-beta": "web-fetch-2025-09-10" }
  });
  ```
- Parse response same as web search (text blocks, citations)
- Handle web_fetch_tool_result blocks and errors
  </action>
  <verify>TypeScript compiles: `npm run typecheck`</verify>
  <done>runWithUrlFetch function enables Claude to fetch URLs (HTML/PDF) with proper beta header and citation support.</done>
</task>

<task type="auto">
  <name>Task 3: Update agent runner with capability flags</name>
  <files>app/services/agent-runner.server.ts</files>
  <action>
Update the agent runner to support optional capability flags.

Update AgentRunParams:
```typescript
export interface AgentRunParams {
  agent: Agent;
  userInput: string;
  encryptedApiKey: string;
  model: ModelId;
  capabilities?: {
    webSearch?: boolean;
    urlFetch?: boolean;
  };
}
```

Update AgentRunResult to include citations:
```typescript
export interface AgentRunResult {
  success: boolean;
  content?: string;
  error?: string;
  citations?: Array<{ url: string; title?: string }>;
  usage?: {
    inputTokens: number;
    outputTokens: number;
  };
}
```

Update runAgent implementation:
- If capabilities.webSearch is true, import and call runWithWebSearch
- If capabilities.urlFetch is true, import and call runWithUrlFetch
- If both false (or undefined), call generateText (existing behavior)
- NOTE: For now, treat webSearch and urlFetch as mutually exclusive with text-only
  (Combined capabilities will be added in Phase 5 execution engine)
- Return citations from capability results
  </action>
  <verify>TypeScript compiles: `npm run typecheck`</verify>
  <done>Agent runner supports capabilities.webSearch and capabilities.urlFetch flags, routing to appropriate capability service.</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes with no errors
- All three capability files exist with proper exports
- Agent runner conditionally uses capabilities based on flags
- Beta header included for web_fetch
- Citations preserved in results
</verification>

<success_criteria>
- Web search capability uses web_search_20250305 with max_uses limit
- URL fetch capability uses web_fetch_20250910 with beta header and citations
- Agent runner routes to correct capability based on flags
- All capabilities return structured results with content, citations, usage
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-capabilities/03-02-SUMMARY.md`
</output>
