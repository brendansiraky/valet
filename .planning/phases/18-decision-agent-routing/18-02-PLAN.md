---
phase: 18-decision-agent-routing
plan: 02
type: execute
wave: 2
depends_on: [18-01]
files_modified:
  - app/components/pipeline-builder/decision-node.tsx
  - app/components/pipeline-builder/agent-node.tsx
  - app/components/pipeline-builder/pipeline-canvas.tsx
autonomous: true

must_haves:
  truths:
    - "Decision nodes render as diamond shape with rotated container"
    - "Decision nodes have target handle at top, TRUE handle at left (green), FALSE handle at right (red)"
    - "Right-click context menu on agent nodes shows 'Toggle Decision Mode' option"
    - "Pipeline canvas registers both agent and decision node types"
    - "Edges from decision nodes display green for TRUE path, red for FALSE path"
  artifacts:
    - path: "app/components/pipeline-builder/decision-node.tsx"
      provides: "Diamond-shaped decision node component with dual source handles"
      exports: ["DecisionNode"]
    - path: "app/components/pipeline-builder/pipeline-canvas.tsx"
      provides: "Node type registration including decision type"
      contains: "decision: DecisionNode"
  key_links:
    - from: "app/components/pipeline-builder/pipeline-canvas.tsx"
      to: "app/components/pipeline-builder/decision-node.tsx"
      via: "nodeTypes object registration"
      pattern: "decision:"
    - from: "app/stores/pipeline-store.ts"
      to: "app/components/pipeline-builder/agent-node.tsx"
      via: "Context menu calls toggleDecisionMode"
      pattern: "toggleDecisionMode"
---

<objective>
Create decision node component with diamond shape and dual output handles, integrate into pipeline canvas.

Purpose: Visual representation of decision agents with TRUE/FALSE routing handles.
Output: DecisionNode component, updated agent node with toggle menu, canvas with both node types.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-decision-agent-routing/18-RESEARCH.md
@.planning/phases/18-decision-agent-routing/18-01-SUMMARY.md

Reference files:
@app/components/pipeline-builder/agent-node.tsx
@app/components/pipeline-builder/pipeline-canvas.tsx
@app/stores/pipeline-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DecisionNode component</name>
  <files>
    app/components/pipeline-builder/decision-node.tsx
  </files>
  <action>
    Create new file `app/components/pipeline-builder/decision-node.tsx`:

    ```typescript
    import { memo } from "react";
    import { Handle, Position, type Node, type NodeProps } from "@xyflow/react";
    import { cn } from "~/lib/utils";
    import type { AgentNodeData } from "~/stores/pipeline-store";

    // Define the full node type for React Flow
    type DecisionNodeType = Node<AgentNodeData, "decision">;

    // Diamond-shaped decision node with TRUE/FALSE output handles
    export const DecisionNode = memo(
      ({ data, selected }: NodeProps<DecisionNodeType>) => {
        return (
          <div className="relative w-[140px] h-[140px]">
            {/* Diamond container - rotated 45 degrees */}
            <div
              className={cn(
                "absolute inset-0 border-2 rounded-md bg-card",
                "border-amber-500/50",
                selected && "ring-2 ring-primary",
                data.isOrphaned && "opacity-70 border-destructive/50 bg-destructive/5"
              )}
              style={{ transform: "rotate(45deg)", transformOrigin: "center" }}
            />

            {/* Counter-rotated content - stays upright */}
            <div className="absolute inset-0 flex flex-col items-center justify-center p-2">
              <span className="text-xs text-muted-foreground uppercase tracking-wide">
                Decision
              </span>
              <span className="text-sm font-medium text-center line-clamp-2 mt-1">
                {data.agentName}
              </span>
            </div>

            {/* Target handle at top center */}
            <Handle
              type="target"
              position={Position.Top}
              className="!bg-muted-foreground !w-3 !h-3"
            />

            {/* TRUE handle at left side (green) */}
            <Handle
              type="source"
              position={Position.Left}
              id="true"
              className="!bg-green-500 !w-3 !h-3"
              title="TRUE path"
            />

            {/* FALSE handle at right side (red) */}
            <Handle
              type="source"
              position={Position.Right}
              id="false"
              className="!bg-red-500 !w-3 !h-3"
              title="FALSE path"
            />

            {/* Handle labels */}
            <span className="absolute -left-2 top-1/2 -translate-y-1/2 -translate-x-full text-[10px] text-green-600 font-medium">
              T
            </span>
            <span className="absolute -right-2 top-1/2 -translate-y-1/2 translate-x-full text-[10px] text-red-600 font-medium">
              F
            </span>
          </div>
        );
      }
    );

    DecisionNode.displayName = "DecisionNode";
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors
    File exists at app/components/pipeline-builder/decision-node.tsx
  </verify>
  <done>
    DecisionNode component created with diamond shape, dual handles (TRUE=green/left, FALSE=red/right)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add context menu toggle to AgentNode</name>
  <files>
    app/components/pipeline-builder/agent-node.tsx
  </files>
  <action>
    Update `app/components/pipeline-builder/agent-node.tsx` to add right-click context menu:

    1. Add imports at top:
       ```typescript
       import { usePipelineStore } from "~/stores/pipeline-store";
       import {
         ContextMenu,
         ContextMenuTrigger,
         ContextMenuContent,
         ContextMenuItem,
       } from "~/components/ui/context-menu";
       import { Diamond, Square } from "lucide-react";
       ```

    2. Inside the AgentNode component, before the return statement, add:
       ```typescript
       const toggleDecisionMode = usePipelineStore((s) => s.toggleDecisionMode);
       ```

    3. Pass the node id via the NodeProps - access it from the second destructured argument:
       Change function signature to include id:
       ```typescript
       ({ id, data, selected }: NodeProps<AgentNodeType>)
       ```

    4. Wrap the entire Card in ContextMenu:
       ```tsx
       return (
         <ContextMenu>
           <ContextMenuTrigger>
             <Card ...existing card jsx...>
               ...handles and content...
             </Card>
           </ContextMenuTrigger>
           <ContextMenuContent>
             <ContextMenuItem onClick={() => toggleDecisionMode(id)}>
               <Diamond className="w-4 h-4 mr-2" />
               Convert to Decision Node
             </ContextMenuItem>
           </ContextMenuContent>
         </ContextMenu>
       );
       ```
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors
    Verify ContextMenu is imported from shadcn components
  </verify>
  <done>
    AgentNode has right-click context menu with "Convert to Decision Node" option
  </done>
</task>

<task type="auto">
  <name>Task 3: Register decision node type and edge styling</name>
  <files>
    app/components/pipeline-builder/pipeline-canvas.tsx
  </files>
  <action>
    Update `app/components/pipeline-builder/pipeline-canvas.tsx`:

    1. Import DecisionNode:
       ```typescript
       import { DecisionNode } from "./decision-node";
       ```

    2. Update nodeTypes object:
       ```typescript
       const nodeTypes = {
         agent: AgentNode,
         decision: DecisionNode,
       };
       ```

    3. Add edge styling - import `useMemo` from React and create edgesWithStyles in PipelineCanvasInner:
       ```typescript
       // Apply colors to decision edges based on sourceHandle
       const edgesWithStyles = useMemo(() => {
         return edges.map((edge) => {
           if (edge.sourceHandle === "true") {
             return {
               ...edge,
               style: { stroke: "#22c55e", strokeWidth: 2 },
               animated: true,
             };
           }
           if (edge.sourceHandle === "false") {
             return {
               ...edge,
               style: { stroke: "#ef4444", strokeWidth: 2 },
               animated: true,
             };
           }
           return edge;
         });
       }, [edges]);
       ```

    4. Update ReactFlow component to use edgesWithStyles:
       ```tsx
       <ReactFlow
         nodes={nodes}
         edges={edgesWithStyles}
         ...rest of props...
       >
       ```
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors
    Run `npm run dev` - app starts without errors
  </verify>
  <done>
    Pipeline canvas registers decision node type, edges from decision nodes show colored paths
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `npm run dev` starts without errors
3. DecisionNode component exists and exports correctly
4. AgentNode has context menu with decision toggle
5. Pipeline canvas nodeTypes includes both agent and decision
6. Decision edges show green (TRUE) and red (FALSE) colors
</verification>

<success_criteria>
- DecisionNode renders as diamond with amber border
- TRUE handle on left (green), FALSE handle on right (red)
- Right-click on regular agent node shows "Convert to Decision Node" option
- Clicking toggle converts node to decision type
- Edges from decision nodes display appropriate colors
</success_criteria>

<output>
After completion, create `.planning/phases/18-decision-agent-routing/18-02-SUMMARY.md`
</output>
