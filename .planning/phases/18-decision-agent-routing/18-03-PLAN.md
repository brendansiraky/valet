---
phase: 18-decision-agent-routing
plan: 03
type: execute
wave: 2
depends_on: [18-01]
files_modified:
  - app/lib/decision-utils.ts
  - app/services/pipeline-executor.server.ts
autonomous: true

must_haves:
  truths:
    - "Decision suffix is appended to agent system prompt when node is decision mode"
    - "DECISION: TRUE/FALSE marker is extracted from agent response"
    - "Marker is stripped from output before passing to next agent"
    - "Missing marker defaults to FALSE with warning log"
  artifacts:
    - path: "app/lib/decision-utils.ts"
      provides: "Decision prompt suffix, parseDecision function"
      exports: ["DECISION_SUFFIX", "parseDecision"]
    - path: "app/services/pipeline-executor.server.ts"
      provides: "buildSystemPrompt supports isDecision parameter"
      contains: "isDecision"
  key_links:
    - from: "app/lib/decision-utils.ts"
      to: "app/services/pipeline-executor.server.ts"
      via: "Import and use parseDecision and DECISION_SUFFIX"
      pattern: "decision-utils"
---

<objective>
Create decision prompt injection and response parsing utilities.

Purpose: Enable agents to output TRUE/FALSE decisions that can be extracted for routing.
Output: Decision suffix constant, parseDecision function, updated buildSystemPrompt.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-decision-agent-routing/18-RESEARCH.md
@.planning/phases/18-decision-agent-routing/18-01-SUMMARY.md

Reference files:
@app/services/pipeline-executor.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create decision utilities module</name>
  <files>
    app/lib/decision-utils.ts
  </files>
  <action>
    Create new file `app/lib/decision-utils.ts`:

    ```typescript
    /**
     * Decision utilities for agent routing.
     * Handles prompt injection and response parsing for decision agents.
     */

    /**
     * Suffix appended to decision agent system prompts.
     * Instructs the agent to output a decision marker.
     */
    export const DECISION_SUFFIX = `

---

After completing your analysis, you MUST end your response with a decision on exactly one line:
DECISION: TRUE
or
DECISION: FALSE

The decision should reflect whether the criteria in your instructions have been met.`;

    /**
     * Regex to extract DECISION marker from agent response.
     * Matches "DECISION: TRUE" or "DECISION: FALSE" at end of content.
     */
    const DECISION_REGEX = /\n?DECISION:\s*(TRUE|FALSE)\s*$/i;

    /**
     * Parse decision marker from agent response.
     * Returns the boolean decision and the content with marker stripped.
     *
     * @param content - Raw agent response content
     * @returns Object with decision boolean and cleaned output
     */
    export function parseDecision(content: string): {
      decision: boolean;
      cleanOutput: string;
      hadMarker: boolean;
    } {
      const match = content.match(DECISION_REGEX);

      if (!match) {
        // No decision marker found - default to FALSE
        console.warn(
          "[decision-utils] No DECISION marker found in agent response. Defaulting to FALSE."
        );
        return {
          decision: false,
          cleanOutput: content,
          hadMarker: false,
        };
      }

      const decision = match[1].toUpperCase() === "TRUE";
      const cleanOutput = content.replace(DECISION_REGEX, "").trim();

      return {
        decision,
        cleanOutput,
        hadMarker: true,
      };
    }
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors
    File exists at app/lib/decision-utils.ts
  </verify>
  <done>
    Decision utilities module created with DECISION_SUFFIX constant and parseDecision function
  </done>
</task>

<task type="auto">
  <name>Task 2: Update buildSystemPrompt to support decision mode</name>
  <files>
    app/services/pipeline-executor.server.ts
  </files>
  <action>
    Update `app/services/pipeline-executor.server.ts`:

    1. Add import at top:
       ```typescript
       import { DECISION_SUFFIX } from "~/lib/decision-utils";
       ```

    2. Update `buildSystemPrompt` function signature to accept `isDecision` parameter:
       ```typescript
       function buildSystemPrompt(
         instructions: string,
         traitContext?: string,
         isDecision?: boolean
       ): string {
         let prompt = instructions;

         if (traitContext) {
           // Prepend trait context to instructions with separator
           prompt = `${traitContext}\n\n---\n\n${prompt}`;
         }

         if (isDecision) {
           // Append decision suffix for decision agents
           prompt += DECISION_SUFFIX;
         }

         return prompt;
       }
       ```

    Note: The function is currently only called in the executor loop. Plan 04 will update
    the executor to pass `isDecision` based on node data. For now, just update the
    function signature and logic - the existing call site will use `undefined` for
    isDecision which correctly skips the suffix.
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors
    Run `npm run dev` - app starts, existing pipeline execution still works
  </verify>
  <done>
    buildSystemPrompt supports optional isDecision parameter, appends DECISION_SUFFIX when true
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `npm run dev` starts without errors
3. decision-utils.ts exports DECISION_SUFFIX and parseDecision
4. buildSystemPrompt accepts isDecision parameter
5. Existing pipeline execution (without decision nodes) still works
</verification>

<success_criteria>
- DECISION_SUFFIX constant defines the prompt injection text
- parseDecision extracts TRUE/FALSE from response, strips marker
- parseDecision defaults to FALSE when marker missing (with warning)
- buildSystemPrompt appends suffix when isDecision=true
- Existing executor behavior unchanged (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/18-decision-agent-routing/18-03-SUMMARY.md`
</output>
