---
phase: 18-decision-agent-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/db/schema/users.ts
  - drizzle/0006_max_iterations.sql
  - app/stores/pipeline-store.ts
autonomous: true

must_haves:
  truths:
    - "Users table has maxIterations field with default of 10"
    - "Pipeline store tracks isDecisionNode boolean per agent node"
    - "toggleDecisionMode action switches node type between agent and decision"
    - "Toggling decision mode off removes edges with sourceHandle"
  artifacts:
    - path: "app/db/schema/users.ts"
      provides: "maxIterations integer field"
      contains: "maxIterations"
    - path: "drizzle/0006_max_iterations.sql"
      provides: "Migration adding max_iterations column"
      contains: "ADD COLUMN max_iterations"
    - path: "app/stores/pipeline-store.ts"
      provides: "isDecisionNode in AgentNodeData, toggleDecisionMode action"
      exports: ["AgentNodeData", "usePipelineStore"]
  key_links:
    - from: "app/db/schema/users.ts"
      to: "drizzle/0006_max_iterations.sql"
      via: "Migration creates column that schema references"
      pattern: "max_iterations"
    - from: "app/stores/pipeline-store.ts"
      to: "toggleDecisionMode"
      via: "Store action manages decision mode state"
      pattern: "toggleDecisionMode"
---

<objective>
Add database field for loop protection and extend pipeline store for decision node tracking.

Purpose: Foundation for decision routing - account-level iteration limits and per-node decision mode state.
Output: Users table migration with maxIterations, pipeline store with isDecisionNode and toggleDecisionMode.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-decision-agent-routing/18-RESEARCH.md

Reference files:
@app/db/schema/users.ts
@app/stores/pipeline-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add maxIterations field to users schema</name>
  <files>
    app/db/schema/users.ts
    drizzle/0006_max_iterations.sql
  </files>
  <action>
    1. In `app/db/schema/users.ts`:
       - Import `integer` from `drizzle-orm/pg-core`
       - Add `maxIterations` field: `integer("max_iterations").notNull().default(10)`
       - Place after passwordHash field

    2. Create `drizzle/0006_max_iterations.sql`:
       ```sql
       -- Add max iterations field for loop protection
       ALTER TABLE users ADD COLUMN max_iterations INTEGER NOT NULL DEFAULT 10;
       ```

    3. Run migration: `npm run db:push` to apply schema
  </action>
  <verify>
    Run `npm run db:push` - should succeed without errors
    Query: `SELECT column_name FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'max_iterations';` returns result
  </verify>
  <done>
    Users table has maxIterations field with default 10, migration applied
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend pipeline store for decision node tracking</name>
  <files>
    app/stores/pipeline-store.ts
  </files>
  <action>
    1. Add `isDecisionNode?: boolean` to `AgentNodeData` type (after traitIds)

    2. Add `toggleDecisionMode: (nodeId: string) => void` to `PipelineState` interface

    3. Implement `toggleDecisionMode` action in the store:
       ```typescript
       toggleDecisionMode: (nodeId) => {
         const { nodes, edges } = get();

         // Find the node
         const nodeIndex = nodes.findIndex(n => n.id === nodeId);
         if (nodeIndex === -1) return;

         const node = nodes[nodeIndex];
         const isCurrentlyDecision = node.data.isDecisionNode ?? false;

         // Update node: toggle isDecisionNode and change type
         const updatedNodes = [...nodes];
         updatedNodes[nodeIndex] = {
           ...node,
           type: isCurrentlyDecision ? "agent" : "decision",
           data: {
             ...node.data,
             isDecisionNode: !isCurrentlyDecision,
           },
         };

         // If toggling OFF decision mode, remove edges with sourceHandle
         // Only remove edges where sourceHandle is "true" or "false"
         let updatedEdges = edges;
         if (isCurrentlyDecision) {
           updatedEdges = edges.filter(
             e => e.source !== nodeId || !e.sourceHandle
           );
         }

         set({ nodes: updatedNodes, edges: updatedEdges });
       },
       ```

    4. Add `toggleDecisionMode` to the store return object (after removeTraitFromNode)
  </action>
  <verify>
    Run `npx tsc --noEmit` - no type errors
    Verify AgentNodeData includes isDecisionNode in type definition
  </verify>
  <done>
    Pipeline store has isDecisionNode field and toggleDecisionMode action, type-checks pass
  </done>
</task>

</tasks>

<verification>
1. `npm run db:push` succeeds
2. `npx tsc --noEmit` passes without errors
3. Pipeline store exports AgentNodeData with isDecisionNode field
4. toggleDecisionMode action implemented in store
</verification>

<success_criteria>
- Users table has max_iterations column with default 10
- Pipeline store AgentNodeData type includes isDecisionNode?: boolean
- toggleDecisionMode action correctly toggles node type and cleans up edges
- All TypeScript types compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-decision-agent-routing/18-01-SUMMARY.md`
</output>
