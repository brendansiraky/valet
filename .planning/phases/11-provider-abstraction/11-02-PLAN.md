---
phase: 11-provider-abstraction
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - app/services/agent-runner.server.ts
  - app/services/pipeline-executor.server.ts
  - app/services/anthropic.server.ts
autonomous: true

must_haves:
  truths:
    - "Agent execution produces same results as before refactor"
    - "Web search and citations still work in agent responses"
    - "Pipeline execution produces same results as before refactor"
    - "Cost tracking shows correct token usage after runs"
  artifacts:
    - path: "app/services/agent-runner.server.ts"
      provides: "Agent execution via provider interface"
      contains: "getProvider"
    - path: "app/services/pipeline-executor.server.ts"
      provides: "Pipeline execution via provider interface"
      contains: "getProvider"
    - path: "app/services/anthropic.server.ts"
      provides: "Anthropic key validation (simplified)"
      exports: ["validateApiKey"]
  key_links:
    - from: "app/services/agent-runner.server.ts"
      to: "app/lib/providers/registry.ts"
      via: "imports getProvider"
      pattern: "import.*getProvider.*from.*providers"
    - from: "app/services/pipeline-executor.server.ts"
      to: "app/lib/providers/registry.ts"
      via: "imports getProvider"
      pattern: "import.*getProvider.*from.*providers"
---

<objective>
Refactor execution services to use provider abstraction layer.

Purpose: Decouple services from Anthropic-specific code so Phase 12 (OpenAI) requires no service changes.

Output: Agent runner and pipeline executor using provider interface; anthropic.server.ts simplified.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-provider-abstraction/11-01-SUMMARY.md

# Files to modify
@app/services/agent-runner.server.ts
@app/services/pipeline-executor.server.ts
@app/services/anthropic.server.ts
@app/services/capabilities/run-with-tools.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor agent-runner.server.ts</name>
  <files>app/services/agent-runner.server.ts</files>
  <action>
Refactor to use provider abstraction:

1. Remove imports from anthropic.server.ts (createAnthropicClient)
2. Remove import of runWithTools
3. Import from provider layer:
   - `getProviderForModel, getProvider` from ~/lib/providers/registry
   - Types from ~/lib/providers/types

4. Update runAgent function:
   - Get provider ID using `getProviderForModel(model)`
   - Decrypt API key
   - Create provider instance: `getProvider(providerId, decryptedKey)`
   - Build ChatMessage array: system message + user message
   - Build ChatOptions with model, tools (web_search + web_fetch)
   - Call provider.chat(messages, options)
   - Map ChatResult to AgentRunResult

Keep AgentRunResult interface unchanged - callers shouldn't need changes.
  </action>
  <verify>
Run agent test from UI - agent should respond with web search/fetch working.
Check that usage tokens are returned correctly.
  </verify>
  <done>
- agent-runner.server.ts uses provider abstraction
- No direct Anthropic SDK imports
- Agent testing still works with citations and usage
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor pipeline-executor.server.ts and simplify anthropic.server.ts</name>
  <files>app/services/pipeline-executor.server.ts, app/services/anthropic.server.ts</files>
  <action>
**pipeline-executor.server.ts:**
1. Remove imports from anthropic.server.ts (createAnthropicClient)
2. Remove import of runWithTools
3. Import provider layer: getProviderForModel, getProvider, types
4. Import decrypt from encryption.server

5. Update executePipeline function:
   - Decrypt API key at start
   - For each step, use provider to run:
     - Create provider instance (or reuse - same key throughout pipeline)
     - Build messages and options
     - Call provider.chat()
   - Map result to existing step output format

Keep PipelineStep and ExecutePipelineParams interfaces unchanged.

**anthropic.server.ts:**
Simplify to only key validation:
1. Keep validateApiKey function (used during API key setup)
2. Remove createAnthropicClient (no longer needed)
3. Remove re-exports of AVAILABLE_MODELS/ModelId (import directly from ~/lib/models)

Update any imports of createAnthropicClient elsewhere to use provider layer instead.
  </action>
  <verify>
Run a pipeline from UI - should execute all steps with progress updates.
Verify cost calculation still works (usage tokens tracked).
Verify citations appear in output.
  </verify>
  <done>
- pipeline-executor.server.ts uses provider abstraction
- anthropic.server.ts contains only validateApiKey
- Pipelines execute correctly with streaming progress
- Cost calculation works
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Agent test run works with web search
3. Pipeline execution works end-to-end
4. Usage/cost tracking works
5. Citations appear in outputs
6. No direct Anthropic SDK usage in agent-runner or pipeline-executor (only in providers/anthropic.ts)
</verification>

<success_criteria>
- Agent runner uses provider.chat() instead of runWithTools
- Pipeline executor uses provider.chat() instead of runWithTools
- anthropic.server.ts only exports validateApiKey
- All existing functionality preserved (web search, fetch, citations, usage)
- No breaking changes to API contracts
</success_criteria>

<output>
After completion, create `.planning/phases/11-provider-abstraction/11-02-SUMMARY.md`
</output>
