---
phase: 11-provider-abstraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/lib/providers/types.ts
  - app/lib/providers/registry.ts
  - app/lib/providers/anthropic.ts
  - app/lib/models.ts
  - app/lib/pricing.ts
autonomous: true

must_haves:
  truths:
    - "Provider interface exists with chat(), validateKey(), getModels() methods"
    - "Provider registry can register and retrieve providers by ID"
    - "Anthropic provider implements the interface using existing SDK patterns"
    - "Models and pricing are organized by provider"
  artifacts:
    - path: "app/lib/providers/types.ts"
      provides: "AIProvider interface and related types"
      exports: ["AIProvider", "ChatMessage", "ChatOptions", "ChatResult", "ProviderModel", "ToolConfig"]
    - path: "app/lib/providers/registry.ts"
      provides: "Provider registration and lookup"
      exports: ["registerProvider", "getProvider", "getProviderForModel", "getAllProviders"]
    - path: "app/lib/providers/anthropic.ts"
      provides: "Anthropic provider implementation"
      exports: ["AnthropicProvider"]
    - path: "app/lib/models.ts"
      provides: "Multi-provider model definitions"
      exports: ["ANTHROPIC_MODELS", "ALL_MODELS", "ModelId"]
    - path: "app/lib/pricing.ts"
      provides: "Multi-provider pricing lookup"
      contains: "MODEL_PRICING keyed by model ID"
  key_links:
    - from: "app/lib/providers/anthropic.ts"
      to: "app/lib/providers/types.ts"
      via: "implements AIProvider"
      pattern: "implements AIProvider"
    - from: "app/lib/providers/anthropic.ts"
      to: "app/lib/models.ts"
      via: "imports ANTHROPIC_MODELS"
      pattern: "import.*ANTHROPIC_MODELS"
    - from: "app/lib/providers/registry.ts"
      to: "app/lib/providers/anthropic.ts"
      via: "auto-registers provider"
      pattern: "registerProvider"
---

<objective>
Create provider abstraction layer with Anthropic as first implementation.

Purpose: Enable multi-provider support (OpenAI in Phase 12) without service rewrites by abstracting AI provider operations behind a common interface.

Output: Provider types, registry, and Anthropic implementation that existing services can adopt.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-provider-abstraction/11-RESEARCH.md

# Existing files to understand
@app/lib/models.ts
@app/lib/pricing.ts
@app/services/capabilities/run-with-tools.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider types and interface</name>
  <files>app/lib/providers/types.ts</files>
  <action>
Create the provider interface file with these types:

1. ChatMessage - message format (role: system/user/assistant, content: string)
2. ChatOptions - model, maxTokens, tools array
3. ChatResult - content, usage (inputTokens/outputTokens), citations array
4. ToolConfig - type (web_search/web_fetch), maxUses optional
5. ProviderModel - id, name, provider string
6. AIProvider interface with:
   - readonly id: string
   - chat(messages: ChatMessage[], options: ChatOptions): Promise<ChatResult>
   - validateKey(apiKey: string): Promise<boolean>
   - getModels(): ProviderModel[]

Keep types minimal - don't over-abstract. These types should work for both Anthropic and OpenAI.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit app/lib/providers/types.ts`</verify>
  <done>Provider interface types exported and compilable</done>
</task>

<task type="auto">
  <name>Task 2: Create provider registry and Anthropic implementation</name>
  <files>app/lib/providers/registry.ts, app/lib/providers/anthropic.ts, app/lib/models.ts, app/lib/pricing.ts</files>
  <action>
**registry.ts:**
Create provider registry with:
- `providers` Map for storage
- `registerProvider(provider: AIProvider)` - adds to map by provider.id
- `getProvider(providerId: string)` - returns provider or throws
- `getProviderForModel(modelId: string)` - determines provider from model ID prefix (claude-* = anthropic)
- `getAllProviders()` - returns array of all registered providers

**anthropic.ts:**
Create AnthropicProvider class implementing AIProvider:
- Constructor takes apiKey string, creates Anthropic client
- `chat()` method:
  - Extract system message from messages array
  - Build Anthropic-specific tool config from ToolConfig[] (web_search_20250305, web_fetch_20250910)
  - Add beta headers for web_fetch if needed
  - Call client.messages.create()
  - Extract text content and citations from response
  - Return ChatResult with usage
- `validateKey()` method: Create test client, make minimal API call, return boolean
- `getModels()` method: Return ANTHROPIC_MODELS mapped to ProviderModel[]

Auto-register: At bottom of anthropic.ts, import registry and call registerProvider(new AnthropicProvider())
Wait - that won't work because AnthropicProvider needs an API key at construction. Instead:
- Export a factory: `createAnthropicProvider(apiKey: string): AnthropicProvider`
- Registry should be lazy - getProvider creates instances as needed, or...
- Better: Registry holds provider metadata, actual provider instances created per-request with API key

Revise registry pattern:
- `getProvider(providerId: string, apiKey: string): AIProvider` - creates provider instance with key
- Registry holds provider factories/constructors, not instances

**models.ts:**
Expand to support multi-provider:
- Rename AVAILABLE_MODELS to ANTHROPIC_MODELS
- Add provider field to model objects
- Export ALL_MODELS (for now just ANTHROPIC_MODELS, OpenAI added in Phase 12)
- Update ModelId type

**pricing.ts:**
No changes needed - already keyed by model ID string. Just ensure pricing lookup works with new model IDs.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify types compile.
Create a quick test in a scratch file that:
- Imports AnthropicProvider
- Confirms getModels() returns expected models
  </verify>
  <done>
- Provider registry can create provider instances
- AnthropicProvider implements AIProvider interface
- Models organized with provider field
- `getProviderForModel("claude-sonnet-4-5-20250929")` returns "anthropic"
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Provider types are importable: `import type { AIProvider } from '~/lib/providers/types'`
3. Registry works: `getProviderForModel("claude-sonnet-4-5-20250929")` returns "anthropic"
4. Models have provider field: `ANTHROPIC_MODELS[0].provider === "anthropic"`
</verification>

<success_criteria>
- Provider interface defined with chat(), validateKey(), getModels()
- AnthropicProvider class implements interface
- Provider registry can look up provider by model ID
- Models organized by provider
- Existing code still compiles (may have import path changes)
</success_criteria>

<output>
After completion, create `.planning/phases/11-provider-abstraction/11-01-SUMMARY.md`
</output>
