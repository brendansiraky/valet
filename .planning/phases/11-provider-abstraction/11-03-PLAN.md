---
phase: 11-provider-abstraction
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - app/services/job-queue.server.ts
autonomous: true

must_haves:
  truths:
    - "Pipeline execution fails clearly when agent has been deleted"
    - "Error message names the deleted agent(s)"
    - "Partial execution doesn't occur (fail-fast on orphan detection)"
  artifacts:
    - path: "app/services/job-queue.server.ts"
      provides: "Orphan detection in buildStepsFromFlow"
      contains: "orphanedAgents"
  key_links:
    - from: "app/services/job-queue.server.ts"
      to: "pipelineRuns table"
      via: "updates status to failed with error"
      pattern: "status.*failed"
---

<objective>
Add orphan handling for deleted agents in pipelines.

Purpose: When a user deletes an agent that's used in a pipeline, execution should fail clearly rather than silently skip steps or produce incomplete output.

Output: Clear error messages when pipelines reference deleted agents.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-provider-abstraction/11-RESEARCH.md

# File to modify
@app/services/job-queue.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add orphan detection in buildStepsFromFlow</name>
  <files>app/services/job-queue.server.ts</files>
  <action>
Modify buildStepsFromFlow() to detect and report deleted agents:

1. Add tracking array: `const orphanedAgents: string[] = [];`

2. In the agent lookup loop, when agent is not found:
   ```typescript
   if (!agent) {
     // Use agentName from node.data if available (stored when agent was added to pipeline)
     const agentName = node.data.agentName ?? agentId;
     orphanedAgents.push(agentName);
     continue; // Don't add to steps
   }
   ```

3. After building steps, check for orphans:
   ```typescript
   if (orphanedAgents.length > 0) {
     throw new Error(
       `Pipeline cannot run: ${orphanedAgents.length} agent(s) have been deleted: ${orphanedAgents.join(", ")}. Please update the pipeline.`
     );
   }
   ```

4. The error will be caught by the worker's error handler and:
   - Update run status to "failed"
   - Store error message in run record
   - Emit error event to client

This is fail-fast: We detect ALL orphans before execution starts, not one at a time.
  </action>
  <verify>
Test scenario:
1. Create a pipeline with 2 agents
2. Delete one agent from the agents list
3. Try to run the pipeline
4. Verify: Run fails with clear error naming the deleted agent
5. Verify: No partial execution occurred
  </verify>
  <done>
- buildStepsFromFlow detects deleted agents
- Error message lists all deleted agent names
- Pipeline run marked as failed with descriptive error
- No partial execution when agents are missing
  </done>
</task>

<task type="auto">
  <name>Task 2: Add orphan indicator in pipeline builder UI</name>
  <files>app/components/pipeline-builder/agent-node.tsx</files>
  <action>
Add visual indicator when an agent node references a deleted agent:

1. In AgentNode component, check if the agent still exists
2. Add a visual indicator (red border, warning icon) if agent is missing
3. Show tooltip: "This agent has been deleted. Remove this node or replace with another agent."

Implementation approach:
- AgentNode already receives agent data from pipeline store
- If agentId doesn't match any agent in the agents list, show orphan state
- This requires passing agents list to the node or checking via React context

Check how AgentNode currently gets its data and add orphan detection.

If this requires significant refactoring of pipeline builder state management, defer to a follow-up task and just add a TODO comment in the code.
  </action>
  <verify>
1. Add agent to pipeline
2. Delete the agent from agents list
3. Open pipeline builder
4. Verify orphaned node shows visual indicator
  </verify>
  <done>
- Orphaned agent nodes visually distinguishable in pipeline builder
- User can identify which nodes need replacement
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Delete agent -> run pipeline with that agent -> fails with clear error
3. Error message includes agent name, not just ID
4. Run status shows "failed" in database
5. UI shows orphan indicator (if implemented)
</verification>

<success_criteria>
- Deleted agents cause clear, early failure with descriptive message
- Users know exactly which agents are missing
- No silent failures or partial execution
- Pipeline builder shows orphan state (visual indicator)
</success_criteria>

<output>
After completion, create `.planning/phases/11-provider-abstraction/11-03-SUMMARY.md`
</output>
