---
phase: 07-navigation-traits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ui/sidebar.tsx
  - app/components/ui/tooltip.tsx
  - app/components/ui/collapsible.tsx
  - app/components/ui/sheet.tsx
  - app/components/app-sidebar.tsx
  - app/components/nav-main.tsx
  - app/layouts/authenticated.tsx
  - app/routes.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated pages have persistent sidebar navigation"
    - "Sidebar can be collapsed and expanded"
    - "User is redirected to /login if not authenticated"
  artifacts:
    - path: "app/components/ui/sidebar.tsx"
      provides: "shadcn sidebar component"
      min_lines: 100
    - path: "app/layouts/authenticated.tsx"
      provides: "Layout with auth check and sidebar"
      exports: ["loader", "default"]
    - path: "app/components/app-sidebar.tsx"
      provides: "App sidebar with navigation"
      min_lines: 30
    - path: "app/routes.ts"
      provides: "Route config with layout wrapper"
      contains: "layout("
  key_links:
    - from: "app/layouts/authenticated.tsx"
      to: "services/session.server"
      via: "getSession in loader"
      pattern: "getSession"
    - from: "app/routes.ts"
      to: "app/layouts/authenticated.tsx"
      via: "layout() wrapper"
      pattern: "layout\\("
---

<objective>
Add persistent sidebar navigation to all authenticated pages using shadcn/ui sidebar component.

Purpose: Provides consistent navigation across the app and centralizes authentication checking in a layout loader rather than duplicating in every route.

Output: Authenticated layout with collapsible sidebar, navigation links to Dashboard, Agents, Pipelines, Traits, and Settings.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-navigation-traits/07-RESEARCH.md
@app/routes.ts
@app/routes/agents.tsx
@app/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn sidebar components</name>
  <files>
    app/components/ui/sidebar.tsx
    app/components/ui/tooltip.tsx
    app/components/ui/collapsible.tsx
    app/components/ui/sheet.tsx
  </files>
  <action>
Run shadcn CLI to install sidebar and required dependencies:

```bash
npx shadcn@latest add sidebar tooltip collapsible sheet
```

This installs:
- sidebar.tsx - Main sidebar component with SidebarProvider, SidebarTrigger, etc.
- tooltip.tsx - For icon tooltips when sidebar collapsed
- collapsible.tsx - For expandable menu sections
- sheet.tsx - For mobile drawer behavior

Verify all four components are created in app/components/ui/.
  </action>
  <verify>
All four files exist:
- `ls app/components/ui/sidebar.tsx` (exists)
- `ls app/components/ui/tooltip.tsx` (exists)
- `ls app/components/ui/collapsible.tsx` (exists)
- `ls app/components/ui/sheet.tsx` (exists)
- `npm run typecheck` passes
  </verify>
  <done>Four shadcn components installed without type errors</done>
</task>

<task type="auto">
  <name>Task 2: Create authenticated layout with sidebar</name>
  <files>
    app/layouts/authenticated.tsx
    app/components/app-sidebar.tsx
    app/components/nav-main.tsx
  </files>
  <action>
Create the layout infrastructure:

**app/layouts/authenticated.tsx:**
- Export `loader` that:
  - Gets session via `getSession(request.headers.get("Cookie"))`
  - Checks `userId` from session
  - Redirects to `/login` if no userId
  - Queries user from database to verify exists
  - Redirects to `/login` if user not found
  - Returns `{ user: { id, email } }` on success
- Export default component that:
  - Uses `useLoaderData<typeof loader>()` to get user
  - Wraps content in `SidebarProvider`
  - Renders `AppSidebar` with user prop
  - Renders `SidebarInset` containing header with `SidebarTrigger` and main with `Outlet`

**app/components/app-sidebar.tsx:**
- Accept `user: { id: string; email: string }` prop
- Return `Sidebar` with `collapsible="icon"` prop
- Include:
  - `SidebarHeader` with app name "Valet" (hidden when collapsed via `group-data-[collapsible=icon]:hidden`)
  - `SidebarContent` with `NavMain` component
  - `SidebarFooter` showing user email and logout link

**app/components/nav-main.tsx:**
- Define navItems array with: Dashboard (/dashboard, Home icon), Agents (/agents, Bot icon), Pipelines (/pipelines, GitBranch icon), Traits (/traits, Sparkles icon), Settings (/settings, Settings icon)
- Use `useLocation()` to determine active item (compare `location.pathname` with item url)
- Render `SidebarMenu` with `SidebarMenuItem` and `SidebarMenuButton` for each item
- Use `Link` from react-router with `asChild` pattern
- Set `isActive` prop on SidebarMenuButton based on pathname match

Icons from lucide-react: Home, Bot, GitBranch, Sparkles, Settings, LogOut
  </action>
  <verify>
- `npm run typecheck` passes
- Files exist: `app/layouts/authenticated.tsx`, `app/components/app-sidebar.tsx`, `app/components/nav-main.tsx`
  </verify>
  <done>Layout exports loader and default, sidebar renders with navigation items</done>
</task>

<task type="auto">
  <name>Task 3: Update routes.ts to use layout wrapper</name>
  <files>app/routes.ts</files>
  <action>
Update app/routes.ts to wrap authenticated routes in the layout:

1. Import `layout` from "@react-router/dev/routes"
2. Restructure routes:
   - Keep public routes (home, register, login, logout) at top level
   - Wrap authenticated routes in `layout("layouts/authenticated.tsx", [...])`
   - Authenticated routes: dashboard, settings, agents, pipelines, pipelines/:id, traits
   - Keep API routes outside layout (they don't render UI)

3. Add traits route inside layout (route("traits", "routes/traits.tsx"))

Final structure:
```typescript
export default [
  // Public routes
  index("routes/home.tsx"),
  route("register", "routes/register.tsx"),
  route("login", "routes/login.tsx"),
  route("logout", "routes/logout.tsx"),

  // Authenticated layout
  layout("layouts/authenticated.tsx", [
    route("dashboard", "routes/dashboard.tsx"),
    route("settings", "routes/settings.tsx"),
    route("agents", "routes/agents.tsx"),
    route("pipelines", "routes/pipelines.tsx"),
    route("pipelines/:id", "routes/pipelines.$id.tsx"),
    route("traits", "routes/traits.tsx"),
  ]),

  // API routes (no layout)
  route("api/agent/:agentId/run", "routes/api.agent.$agentId.run.ts"),
  route("api/pipelines", "routes/api.pipelines.ts"),
  route("api/pipeline/:pipelineId/run", "routes/api.pipeline.$pipelineId.run.ts"),
  route("api/pipeline/run/:runId/stream", "routes/api.pipeline.run.$runId.stream.ts"),
] satisfies RouteConfig;
```

Note: The traits route file will be created by Plan 02. For now, it's in the route config but may not exist yet - that's fine, React Router handles missing files gracefully during dev.
  </action>
  <verify>
- `npm run typecheck` passes
- `grep -q "layout(" app/routes.ts` confirms layout wrapper exists
- App still builds: `npm run build` (or at minimum `npm run typecheck`)
  </verify>
  <done>routes.ts uses layout() to wrap authenticated routes, includes traits route</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run dev` - app starts without errors
2. Visit `/dashboard` while logged out - redirects to `/login`
3. Log in and visit `/dashboard` - sidebar visible on left
4. Click sidebar collapse button - sidebar collapses to icons only
5. Click collapse button again - sidebar expands
6. Navigate between Dashboard, Agents, Pipelines, Settings - sidebar persists
7. Active nav item is highlighted based on current route
</verification>

<success_criteria>
- Authenticated routes show sidebar
- Sidebar collapses/expands
- Auth redirect works for unauthenticated users
- Navigation links work and show active state
- Mobile: sidebar becomes drawer (sheet)
</success_criteria>

<output>
After completion, create `.planning/phases/07-navigation-traits/07-01-SUMMARY.md`
</output>
