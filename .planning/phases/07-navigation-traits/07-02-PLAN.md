---
phase: 07-navigation-traits
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/db/schema/traits.ts
  - app/db/index.ts
  - drizzle/migrations/NNNN_traits.sql
  - app/routes/traits.tsx
  - app/components/trait-card.tsx
  - app/components/trait-form-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a new trait with name and context"
    - "User can edit an existing trait"
    - "User can delete a trait"
    - "User can view their trait library"
  artifacts:
    - path: "app/db/schema/traits.ts"
      provides: "Traits table schema"
      exports: ["traits", "Trait", "NewTrait"]
    - path: "app/routes/traits.tsx"
      provides: "Traits CRUD page"
      exports: ["loader", "action", "default"]
    - path: "app/components/trait-form-dialog.tsx"
      provides: "Create/edit trait dialog"
      min_lines: 40
    - path: "app/components/trait-card.tsx"
      provides: "Trait display card with actions"
      min_lines: 30
  key_links:
    - from: "app/routes/traits.tsx"
      to: "app/db/schema/traits.ts"
      via: "db.query.traits"
      pattern: "db\\.query\\.traits"
    - from: "app/routes/traits.tsx"
      to: "app/db"
      via: "insert/update/delete operations"
      pattern: "db\\.(insert|update|delete)"
---

<objective>
Create traits CRUD system allowing users to create, edit, delete, and view reusable context snippets.

Purpose: Traits are reusable context text that can be attached to agents (in Phase 8). This phase establishes the traits data model and management UI.

Output: Traits database table, traits page with CRUD functionality, form dialog for create/edit, card component for display.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-navigation-traits/07-RESEARCH.md
@app/db/schema/agents.ts
@app/db/index.ts
@app/routes/agents.tsx
@app/components/agent-card.tsx
@app/components/agent-form-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create traits database schema and migration</name>
  <files>
    app/db/schema/traits.ts
    app/db/index.ts
  </files>
  <action>
Create traits schema following the agents pattern exactly:

**app/db/schema/traits.ts:**
```typescript
import { index, pgTable, text, timestamp } from "drizzle-orm/pg-core";
import { users } from "./users";

export const traits = pgTable(
  "traits",
  {
    id: text("id")
      .primaryKey()
      .$defaultFn(() => crypto.randomUUID()),
    userId: text("user_id")
      .notNull()
      .references(() => users.id, { onDelete: "cascade" }),
    name: text("name").notNull(),
    context: text("context").notNull(),
    createdAt: timestamp("created_at").defaultNow().notNull(),
    updatedAt: timestamp("updated_at")
      .defaultNow()
      .notNull()
      .$onUpdateFn(() => new Date()),
  },
  (table) => [index("traits_user_id_idx").on(table.userId)]
);

export type Trait = typeof traits.$inferSelect;
export type NewTrait = typeof traits.$inferInsert;
```

**Update app/db/index.ts:**
- Add import: `import * as traits from "./schema/traits";`
- Add to schema object: `...traits`
- Add export: `export * from "./schema/traits";`

**Run migration:**
```bash
npx drizzle-kit generate
npx drizzle-kit push
```

The generate command creates a migration file. The push command applies it.
  </action>
  <verify>
- `npm run typecheck` passes
- `npx drizzle-kit push` succeeds (table created)
- Can import `{ traits, Trait }` from `~/db`
  </verify>
  <done>Traits table exists in database with userId index</done>
</task>

<task type="auto">
  <name>Task 2: Create trait UI components</name>
  <files>
    app/components/trait-card.tsx
    app/components/trait-form-dialog.tsx
  </files>
  <action>
Create UI components following the agent-card and agent-form-dialog patterns:

**app/components/trait-form-dialog.tsx:**
- Props: `trigger: React.ReactNode`, `trait?: { id: string; name: string; context: string }`
- Determine `isEditing` from presence of trait prop
- Render Dialog with DialogTrigger wrapping trigger prop
- DialogContent with DialogHeader/DialogTitle ("Create Trait" or "Edit Trait")
- Form with method="post" and space-y-4 class
- Hidden inputs: `intent` (create or update), `traitId` (if editing)
- Input for name: required, defaultValue from trait
- Textarea for context: required, 6 rows, defaultValue from trait, placeholder "Enter reusable context that can be attached to agents..."
- Submit Button: "Create Trait" or "Save Changes"

**app/components/trait-card.tsx:**
- Props: `trait: { id: string; name: string; context: string; updatedAt: Date }`
- Render Card with CardHeader containing:
  - CardTitle with trait.name
  - CardDescription with "Updated {relative time}" using updatedAt
- CardContent showing context text (truncate with line-clamp-3)
- CardFooter with three buttons:
  - Edit button wrapped in TraitFormDialog with trait prop
  - Delete button in Form with method="post", hidden intent="delete" and traitId inputs
- Use Pencil, Trash2 icons from lucide-react
- Format relative time (e.g., "2 hours ago") using simple logic or just show date
  </action>
  <verify>
- `npm run typecheck` passes
- Both files export their components
  </verify>
  <done>TraitFormDialog and TraitCard components created with proper props</done>
</task>

<task type="auto">
  <name>Task 3: Create traits route with CRUD actions</name>
  <files>app/routes/traits.tsx</files>
  <action>
Create traits.tsx following the agents.tsx pattern exactly:

**Loader:**
- Get session, extract userId
- If no userId, redirect to /login
- Verify user exists in db, redirect if not
- Query traits for this user: `db.query.traits.findMany({ where: eq(traits.userId, userId), orderBy: [desc(traits.updatedAt)] })`
- Return `{ traits: userTraits }`

**Action:**
- Get session, validate userId
- Get formData and intent

- Intent "create":
  - Validate with zod schema (name: string min 1 max 100, context: string min 1 max 50000)
  - Insert: `db.insert(traits).values({ userId, name, context })`
  - Return `{ success: true }`

- Intent "update":
  - Get traitId from formData
  - Validate with same zod schema
  - Update with ownership check: `db.update(traits).set({ name, context }).where(and(eq(traits.id, traitId), eq(traits.userId, userId)))`
  - Return `{ success: true }`

- Intent "delete":
  - Get traitId from formData
  - Delete with ownership check: `db.delete(traits).where(and(eq(traits.id, traitId), eq(traits.userId, userId)))`
  - Return `{ success: true }`

**Component:**
- useLoaderData to get traits
- Layout similar to agents.tsx:
  - div with min-h-screen px-4 py-8
  - mx-auto max-w-6xl container
  - Header with "My Traits" title, description, Create button with TraitFormDialog
  - Empty state Card if no traits
  - Grid of TraitCards if traits exist (grid gap-4 md:grid-cols-2 lg:grid-cols-3)

Imports needed:
- From react-router: LoaderFunctionArgs, ActionFunctionArgs, redirect, useLoaderData, data
- From zod: z
- From ~/services/session.server: getSession
- From ~/db: db, users, traits
- From drizzle-orm: eq, and, desc
- From lucide-react: Plus
- UI components: Card, CardContent, CardDescription, CardHeader, CardTitle, Button
- Local components: TraitCard, TraitFormDialog
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run dev` and navigate to /traits (after logging in)
- Can create a trait, see it in the list
- Can edit a trait, changes persist
- Can delete a trait, it disappears
  </verify>
  <done>Traits page shows trait library, supports create/edit/delete operations</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run dev` - app starts
2. Log in and navigate to /traits
3. Create a trait with name "Expert Writer" and context "You are an expert technical writer..."
4. Trait appears in list
5. Edit the trait - change name to "Technical Writer"
6. Changes are saved
7. Delete the trait
8. Trait is removed from list
9. Create multiple traits - they appear in grid layout
</verification>

<success_criteria>
- Traits table exists in database
- User can create traits with name and context
- User can edit existing traits
- User can delete traits
- User can view their trait library
- Traits are user-scoped (can't see other users' traits)
- Cascade delete works (if user deleted, traits deleted)
</success_criteria>

<output>
After completion, create `.planning/phases/07-navigation-traits/07-02-SUMMARY.md`
</output>
