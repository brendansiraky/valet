---
phase: 15-agent-dna-simplification
plan: 03
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - app/routes/pipelines.$id.tsx
  - app/routes/api.pipelines.ts
  - app/routes/api.pipeline.$pipelineId.run.ts
  - app/services/job-queue.server.ts
  - app/services/pipeline-executor.server.ts
autonomous: true

must_haves:
  truths:
    - "Pipeline run button starts execution immediately (no variable dialog)"
    - "Pipeline executor does not substitute variables in instructions"
    - "API endpoints do not accept or store variables"
    - "No VariableFillDialog or TemplateDialog usage in pipelines route"
  artifacts:
    - path: "app/routes/pipelines.$id.tsx"
      provides: "Pipeline page without variable dialogs or template button"
      min_lines: 200
    - path: "app/services/pipeline-executor.server.ts"
      provides: "Executor without substituteVariables function"
      min_lines: 150
  key_links:
    - from: "app/routes/pipelines.$id.tsx"
      to: "startPipelineRun"
      via: "handleRun direct call"
---

<objective>
Remove all variable system code from the pipeline routes, API endpoints, and executor service. Clean up unused imports and state management.

Purpose: Complete the variable system removal by cleaning up all consuming code now that the database schema no longer has variables.

Output: Simplified pipeline page that runs immediately without variable prompts, cleaned executor without variable substitution.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-agent-dna-simplification/15-RESEARCH.md
@.planning/phases/15-agent-dna-simplification/15-02-SUMMARY.md

Reference files:
@app/routes/pipelines.$id.tsx
@app/routes/api.pipelines.ts
@app/routes/api.pipeline.$pipelineId.run.ts
@app/services/job-queue.server.ts
@app/services/pipeline-executor.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove variable system from pipeline executor</name>
  <files>app/services/pipeline-executor.server.ts</files>
  <action>
1. Remove the substituteVariables function (lines 37-49):
   ```typescript
   // DELETE THIS ENTIRE FUNCTION:
   function substituteVariables(
     text: string,
     variables?: Record<string, string>
   ): string {
     ...
   }
   ```

2. Remove `variables` from ExecutePipelineParams interface (line 33):
   ```typescript
   // DELETE THIS LINE from the interface:
   variables?: Record<string, string>;
   ```

3. Remove `variables` from destructuring in executePipeline (line 69):
   ```typescript
   // Change from:
   const { runId, steps, initialInput, encryptedApiKey, model, variables } = params;
   // To:
   const { runId, steps, initialInput, encryptedApiKey, model } = params;
   ```

4. Remove substituteVariables call (lines 119-123):
   ```typescript
   // DELETE OR REPLACE:
   const substitutedInstructions = substituteVariables(
     step.instructions,
     variables
   );
   // WITH:
   const substitutedInstructions = step.instructions;
   ```
   (Or just use `step.instructions` directly in buildSystemPrompt call)

5. Update the user message logic (lines 127-139) to remove variable handling:
   ```typescript
   // Replace the entire if/else block with:
   let userMessage: string;
   if (currentInput.trim()) {
     userMessage = currentInput;
   } else {
     userMessage = "Please proceed with your instructions.";
   }
   ```
   Remove the `else if (variables && Object.keys(variables).length > 0)` branch entirely.

6. Update buildSystemPrompt call to use step.instructions directly:
   ```typescript
   const systemPrompt = buildSystemPrompt(step.instructions, step.traitContext);
   ```
  </action>
  <verify>
- `npm run typecheck` passes
- No references to `variables` or `substituteVariables` in file
- File still exports executePipeline function
  </verify>
  <done>
- substituteVariables function removed
- ExecutePipelineParams no longer has variables field
- executePipeline uses instructions directly without substitution
- User message logic simplified (no variable context)
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove variables from job queue and run API</name>
  <files>app/services/job-queue.server.ts, app/routes/api.pipeline.$pipelineId.run.ts</files>
  <action>
1. In app/services/job-queue.server.ts:
   - Remove `variables` from PipelineRunJob interface (line 16):
     ```typescript
     // DELETE:
     variables?: Record<string, string>;
     ```
   - Remove `variables` from destructuring (line 50):
     ```typescript
     // Change from:
     const { runId, pipelineId, userId, input, variables } = job.data;
     // To:
     const { runId, pipelineId, userId, input } = job.data;
     ```
   - Remove `variables` from executePipeline call (line 119):
     ```typescript
     // Remove this line:
     variables,
     ```

2. In app/routes/api.pipeline.$pipelineId.run.ts:
   - Remove variables parsing (lines 44-45):
     ```typescript
     // DELETE:
     const variablesJson = formData.get("variables") as string;
     const variables = variablesJson ? JSON.parse(variablesJson) : undefined;
     ```
   - Remove variables from insert (line 54):
     ```typescript
     // DELETE this line from .values():
     variables,
     ```
   - Remove variables from queue.send data (lines 69-70):
     ```typescript
     // DELETE:
     variables,
     ```
  </action>
  <verify>
- `npm run typecheck` passes
- No references to `variables` in job-queue.server.ts
- No references to `variables` in api.pipeline.$pipelineId.run.ts
  </verify>
  <done>
- PipelineRunJob interface has no variables field
- Job queue worker doesn't pass variables to executor
- Run API doesn't parse or store variables
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove variable dialogs and template system from pipelines page</name>
  <files>app/routes/pipelines.$id.tsx</files>
  <action>
1. Remove imports for variable/template dialogs and types (lines 11-15):
   ```typescript
   // DELETE these imports:
   import {
     TemplateDialog,
     type TemplateVariable,
   } from "~/components/pipeline-builder/template-dialog";
   import { VariableFillDialog } from "~/components/pipeline-builder/variable-fill-dialog";
   ```
   Also remove `pipelineTemplates` from the db import and `FileCode` from lucide-react.

2. Remove template-related loader logic (lines 57-62):
   ```typescript
   // DELETE:
   const [template] = await db
     .select()
     .from(pipelineTemplates)
     .where(eq(pipelineTemplates.pipelineId, id!));
   ```
   Update return to not include template:
   ```typescript
   return { pipeline, agents: userAgents };
   ```

3. Remove template-related state (lines 73-77):
   ```typescript
   // DELETE these state declarations:
   const [templateDialogOpen, setTemplateDialogOpen] = useState(false);
   const [variableFillDialogOpen, setVariableFillDialogOpen] = useState(false);
   const [templateVariables, setTemplateVariables] = useState<TemplateVariable[]>(template?.variables || []);
   ```

4. Remove template from useLoaderData destructuring:
   ```typescript
   // Change from:
   const { pipeline, agents: userAgents, template } = useLoaderData<typeof loader>();
   // To:
   const { pipeline, agents: userAgents } = useLoaderData<typeof loader>();
   ```

5. Remove handleSaveTemplate callback (lines 213-235).

6. Update startPipelineRun to not accept variables (lines 246-278):
   ```typescript
   const startPipelineRun = async (input: string) => {
     if (!pipelineId) return;

     setIsStartingRun(true);
     try {
       const formData = new FormData();
       formData.set("input", input);

       const response = await fetch(`/api/pipeline/${pipelineId}/run`, {
         method: "POST",
         body: formData,
       });
       ...
     }
   };
   ```

7. Simplify handleRun to call startPipelineRun directly (lines 280-288):
   ```typescript
   const handleRun = async () => {
     await startPipelineRun("");
   };
   ```

8. Remove handleRunWithVariables function (lines 290-294).

9. Remove the "Save as Template" / "Edit Template" button from header (lines 340-346).

10. Remove the dialog components at bottom of JSX (lines 419-435):
    ```tsx
    // DELETE the entire {pipelineId && (...)} block containing TemplateDialog and VariableFillDialog
    ```
  </action>
  <verify>
- `npm run typecheck` passes
- No imports of TemplateDialog or VariableFillDialog
- No templateVariables state
- Run button works directly without dialogs
  </verify>
  <done>
- TemplateDialog and VariableFillDialog removed from imports
- No template-related state or handlers
- Run button executes immediately
- No "Save as Template" button in header
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` - no type errors
2. `npm run dev` - app starts
3. Navigate to /pipelines, open a pipeline:
   - No "Save as Template" / "Edit Template" button
   - Click Run - pipeline starts immediately (no dialog)
   - Pipeline executes successfully
4. Check console for errors during execution
5. Verify output viewer still works after run completes
</verification>

<success_criteria>
1. No variable substitution in pipeline executor
2. No variable handling in job queue or run API
3. No template dialogs in pipeline page
4. Run button starts pipeline immediately
5. Pipeline execution works end-to-end
6. No TypeScript errors related to removed types
</success_criteria>

<output>
After completion, create `.planning/phases/15-agent-dna-simplification/15-03-SUMMARY.md`
</output>
