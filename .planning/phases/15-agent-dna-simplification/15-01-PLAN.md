---
phase: 15-agent-dna-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/agent-form-dialog.tsx
  - app/components/agent-test-dialog.tsx
  - app/routes/api.agent.$agentId.run.ts
  - app/routes/agents.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 'DNA' label instead of 'Instructions' on agent form"
    - "User sees info tooltip explaining DNA when hovering info icon"
    - "Agent form has no trait selector section"
    - "User can select traits temporarily when testing an agent"
    - "Test runs use selected traits without persisting to agent"
  artifacts:
    - path: "app/components/agent-form-dialog.tsx"
      provides: "DNA label with tooltip, no trait selector"
      contains: "DNA"
    - path: "app/components/agent-test-dialog.tsx"
      provides: "Temporary trait picker UI"
      contains: "selectedTraitIds"
    - path: "app/routes/api.agent.$agentId.run.ts"
      provides: "Accept traitIds from request body"
      contains: "traitIds"
  key_links:
    - from: "app/routes/agents.tsx"
      to: "AgentTestDialog"
      via: "traits prop"
      pattern: "traits={userTraits}"
    - from: "app/components/agent-test-dialog.tsx"
      to: "/api/agent/:id/run"
      via: "fetcher submit with traitIds"
      pattern: "traitIds"
---

<objective>
Rename "Instructions" to "DNA" in agent forms, add explanatory tooltip, remove trait selector from agent form, and add temporary trait picker to agent test dialog.

Purpose: Make the agent form more human-friendly for non-technical users ("DNA" metaphor) and shift trait assignment from agent-level to per-context (test now, pipeline later).

Output: Updated agent form with DNA label/tooltip, agent test dialog with trait picker, updated API endpoint accepting trait IDs.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-agent-dna-simplification/15-RESEARCH.md

Reference files:
@app/components/agent-form-dialog.tsx
@app/components/agent-test-dialog.tsx
@app/routes/api.agent.$agentId.run.ts
@app/routes/agents.tsx
@app/components/ui/tooltip.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename Instructions to DNA with tooltip, remove trait selector</name>
  <files>app/components/agent-form-dialog.tsx</files>
  <action>
1. Import Tooltip components and Info icon:
   ```tsx
   import { Info } from "lucide-react";
   import { Tooltip, TooltipTrigger, TooltipContent } from "~/components/ui/tooltip";
   ```

2. Replace the instructions label section (around line 99-120) with DNA label + tooltip:
   - Keep `name="instructions"` on the Textarea for backward compatibility
   - Change the visible Label from "Instructions" to "DNA"
   - Add info icon with tooltip next to label
   - Tooltip text: "Your agent's DNA defines its core personality and behavior - the fundamental instructions that shape how it thinks and responds."
   - Update the helper text below textarea to reference DNA

3. Remove the entire traits section (around line 134-168):
   - Remove the `<div className="space-y-2">` containing the Label "Traits"
   - Remove the traits checkbox list
   - Remove the hidden input for `traitsUpdated`
   - Remove the hidden inputs for `traitIds`

4. Remove selectedTraitIds state and related useEffect (lines 40, 52-57):
   - Delete `const [selectedTraitIds, setSelectedTraitIds] = useState<string[]>([]);`
   - Delete the useEffect that initializes selectedTraitIds

5. Update component props interface to remove traits (optional - keep for now if it breaks)

Pattern for DNA label:
```tsx
<div className="space-y-2">
  <div className="flex items-center gap-1.5">
    <Label htmlFor="instructions">DNA</Label>
    <Tooltip>
      <TooltipTrigger asChild>
        <button type="button" className="inline-flex">
          <Info className="h-4 w-4 text-muted-foreground" />
          <span className="sr-only">What is DNA?</span>
        </button>
      </TooltipTrigger>
      <TooltipContent side="right" className="max-w-[240px]">
        Your agent's DNA defines its core personality and behavior -
        the fundamental instructions that shape how it thinks and responds.
      </TooltipContent>
    </Tooltip>
  </div>
  <Textarea ... />
</div>
```
  </action>
  <verify>
- `npm run typecheck` passes
- Open app, navigate to /agents, click Create Agent
- See "DNA" label with (i) icon
- Hover (i) icon, see tooltip
- No traits section visible in form
  </verify>
  <done>
- Instructions field shows "DNA" label with info icon
- Tooltip appears on hover with explanatory text
- No trait selector in agent form
- Form still submits correctly (name="instructions" preserved)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add temporary trait picker to agent test dialog</name>
  <files>app/components/agent-test-dialog.tsx, app/routes/agents.tsx</files>
  <action>
1. Update AgentTestDialogProps interface in agent-test-dialog.tsx:
   ```tsx
   interface AgentTestDialogProps {
     agent: Pick<Agent, "id" | "name">;
     traits: Array<{ id: string; name: string }>;  // Add this
     open: boolean;
     onOpenChange: (open: boolean) => void;
   }
   ```

2. Add state for selected traits:
   ```tsx
   const [selectedTraitIds, setSelectedTraitIds] = useState<string[]>([]);
   ```

3. Import Checkbox and Label:
   ```tsx
   import { Checkbox } from "~/components/ui/checkbox";
   ```
   (Label already imported)

4. Add trait picker UI between input section and submit button:
   ```tsx
   {/* Trait Picker */}
   {traits.length > 0 && (
     <div className="space-y-2">
       <Label>Test with traits (optional)</Label>
       <div className="max-h-32 overflow-y-auto space-y-2 border rounded-md p-3">
         {traits.map((trait) => (
           <div key={trait.id} className="flex items-center space-x-2">
             <Checkbox
               id={`test-trait-${trait.id}`}
               checked={selectedTraitIds.includes(trait.id)}
               onCheckedChange={(checked) => {
                 setSelectedTraitIds((prev) =>
                   checked ? [...prev, trait.id] : prev.filter((id) => id !== trait.id)
                 );
               }}
             />
             <label htmlFor={`test-trait-${trait.id}`} className="text-sm cursor-pointer">
               {trait.name}
             </label>
           </div>
         ))}
       </div>
     </div>
   )}
   ```

5. Update handleSubmit to include traitIds:
   ```tsx
   fetcher.submit(
     { input: input.trim(), traitIds: selectedTraitIds },
     {
       method: "POST",
       action: `/api/agent/${agent.id}/run`,
       encType: "application/json",
     }
   );
   ```

6. Update agents.tsx to pass traits to AgentTestDialog:
   - The loader already fetches userTraits
   - Update the AgentTestDialog usage to include traits prop:
   ```tsx
   <AgentTestDialog
     agent={testingAgent}
     traits={userTraits}  // Add this
     open={!!testingAgent}
     onOpenChange={(open) => !open && setTestingAgent(null)}
   />
   ```
  </action>
  <verify>
- `npm run typecheck` passes
- Open app, go to /agents, click Test on any agent
- See trait picker (if user has traits)
- Select traits, run test
- Traits reset when dialog closes and reopens
  </verify>
  <done>
- Agent test dialog shows trait picker when traits exist
- User can select multiple traits for testing
- Trait selection resets on dialog close (React state naturally resets)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update API endpoint to accept and use trait IDs</name>
  <files>app/routes/api.agent.$agentId.run.ts</files>
  <action>
1. Update RunAgentSchema to accept traitIds:
   ```tsx
   const RunAgentSchema = z.object({
     input: z.string().min(1, "Input is required"),
     traitIds: z.array(z.string()).optional(),
   });
   ```

2. Add import for inArray:
   ```tsx
   import { eq, and, inArray } from "drizzle-orm";
   ```

3. Add import for traits table:
   ```tsx
   import { db, agents, apiKeys, agentTraits, traits } from "~/db";
   ```

4. Replace the existing trait loading logic (lines 77-91) with new logic that uses traitIds from request:
   ```tsx
   // Load trait context - use provided traitIds if any, otherwise fall back to agent's traits
   const traitIds = result.data.traitIds || [];
   let traitContext: string | undefined;

   if (traitIds.length > 0) {
     // Use explicitly selected traits from request
     const selectedTraits = await db.query.traits.findMany({
       where: and(
         eq(traits.userId, userId),
         inArray(traits.id, traitIds)
       ),
     });
     traitContext = selectedTraits
       .map((t) => `## ${t.name}\n\n${t.context}`)
       .join("\n\n---\n\n");
   } else {
     // Fall back to agent's assigned traits (for backward compatibility)
     const assignments = await db.query.agentTraits.findMany({
       where: eq(agentTraits.agentId, agentId),
       with: {
         trait: {
           columns: { name: true, context: true },
         },
       },
     });
     traitContext = assignments.length > 0
       ? assignments
           .map((a) => `## ${a.trait.name}\n\n${a.trait.context}`)
           .join("\n\n---\n\n")
       : undefined;
   }
   ```

Note: We keep the fallback to agent's traits for backward compatibility during the transition. This will be removed when Phase 17 fully moves traits to pipeline-level.
  </action>
  <verify>
- `npm run typecheck` passes
- Test agent with no traits selected - uses agent's assigned traits (fallback)
- Test agent with traits selected - uses only selected traits
- API returns correct response with trait context applied
  </verify>
  <done>
- API accepts optional traitIds array in request body
- When traitIds provided, uses those traits for context
- When no traitIds, falls back to agent's assigned traits
- Trait context formatted correctly in prompt
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` - no type errors
2. `npm run dev` - app starts without errors
3. Navigate to /agents:
   - Click "Create Agent" - see DNA label with tooltip, no traits section
   - Create an agent, verify it saves
   - Edit an agent, verify DNA label and no traits
4. Test agent functionality:
   - Click Test on an agent
   - See trait picker (if traits exist)
   - Select some traits, run test
   - Verify response includes trait context
   - Close and reopen dialog - traits should be unchecked
5. Verify no regressions in pipeline execution (traits still loaded from agent assignments)
</verification>

<success_criteria>
1. "DNA" label with tooltip visible on all agent forms (create/edit)
2. No trait selector in agent forms
3. Trait picker visible in agent test dialog
4. Test runs work with selected traits
5. Trait selection is temporary (resets on dialog close)
6. Existing functionality (pipeline runs with agent traits) still works
</success_criteria>

<output>
After completion, create `.planning/phases/15-agent-dna-simplification/15-01-SUMMARY.md`
</output>
