---
phase: 15-agent-dna-simplification
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - app/db/schema/pipelines.ts
  - app/db/schema/pipeline-runs.ts
  - drizzle/migrations/NNNN_remove_variables.sql
autonomous: true

must_haves:
  truths:
    - "TemplateVariable type no longer exists in codebase"
    - "pipelineTemplates table has no variables column"
    - "pipelineRuns table has no variables column"
    - "Database migration runs successfully"
  artifacts:
    - path: "app/db/schema/pipelines.ts"
      provides: "Schema without variables column or TemplateVariable type"
      min_lines: 40
    - path: "app/db/schema/pipeline-runs.ts"
      provides: "Schema without variables column"
      min_lines: 50
    - path: "drizzle/migrations/*_remove_variables.sql"
      provides: "Migration to drop variables columns"
      contains: "DROP COLUMN"
  key_links:
    - from: "drizzle/migrations"
      to: "database"
      via: "drizzle-kit migrate"
---

<objective>
Remove the template variable system from the database schema. Drop the variables column from pipelineTemplates and pipelineRuns tables, and remove the TemplateVariable type.

Purpose: Clean up the database schema as part of removing the over-engineered variable system. The DNA + traits model replaces it.

Output: Updated Drizzle schema files, generated migration, migrated database.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-agent-dna-simplification/15-RESEARCH.md

Reference files:
@app/db/schema/pipelines.ts
@app/db/schema/pipeline-runs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove variables from Drizzle schema files</name>
  <files>app/db/schema/pipelines.ts, app/db/schema/pipeline-runs.ts</files>
  <action>
1. In app/db/schema/pipelines.ts:
   - Remove the TemplateVariable interface (lines 24-29):
     ```typescript
     // DELETE THIS:
     export interface TemplateVariable {
       name: string;
       description?: string;
       defaultValue?: string;
     }
     ```
   - Remove the variables column from pipelineTemplates table (line 61):
     ```typescript
     // DELETE THIS LINE:
     variables: jsonb("variables").notNull().$type<TemplateVariable[]>(),
     ```
   - The pipelineTemplates table should now only have: id, pipelineId, createdAt

2. In app/db/schema/pipeline-runs.ts:
   - Remove the variables column (line 34):
     ```typescript
     // DELETE THIS LINE:
     variables: jsonb("variables").$type<Record<string, string>>(),
     ```

3. Verify the schema files compile:
   - Run `npm run typecheck` to catch any type errors from removed types
  </action>
  <verify>
- `npm run typecheck` passes (may show errors in files that import TemplateVariable - those will be fixed in Plan 03)
- Schema files have no variables-related code
  </verify>
  <done>
- TemplateVariable type removed from pipelines.ts
- variables column removed from pipelineTemplates table definition
- variables column removed from pipelineRuns table definition
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate and run database migration</name>
  <files>drizzle/migrations/NNNN_remove_variables.sql</files>
  <action>
1. Generate the migration using Drizzle Kit:
   ```bash
   npx drizzle-kit generate --name remove_variables
   ```
   This will create a new migration file in drizzle/migrations/

2. Review the generated migration to ensure it:
   - Drops the `variables` column from `pipeline_templates`
   - Drops the `variables` column from `pipeline_runs`
   - Does NOT drop any tables

3. Run the migration:
   ```bash
   npx drizzle-kit migrate
   ```

4. Verify migration applied:
   - Check that migration completed without errors
   - The database tables should no longer have variables columns

Note: Existing data in the variables columns will be lost. This is intentional - the feature is being removed entirely.
  </action>
  <verify>
- Migration file exists in drizzle/migrations/
- Migration contains ALTER TABLE DROP COLUMN statements
- `npx drizzle-kit migrate` runs successfully
- No errors about missing columns
  </verify>
  <done>
- Migration file generated with correct DROP COLUMN statements
- Migration applied to database successfully
- Database schema matches Drizzle schema
  </done>
</task>

</tasks>

<verification>
1. Schema files compile: `npm run typecheck` (may have errors in consuming files - expected)
2. Migration generated: `ls drizzle/migrations/` shows new migration
3. Migration content: Contains DROP COLUMN for both tables
4. Database migrated: `npx drizzle-kit migrate` succeeded
5. App starts: `npm run dev` - no database schema mismatch errors
</verification>

<success_criteria>
1. TemplateVariable type removed from codebase
2. variables column removed from pipelineTemplates schema
3. variables column removed from pipelineRuns schema
4. Database migration created and applied
5. App can connect to database without schema errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-agent-dna-simplification/15-02-SUMMARY.md`
</output>
