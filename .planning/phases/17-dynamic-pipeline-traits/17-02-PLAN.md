---
phase: 17-dynamic-pipeline-traits
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - app/components/pipeline-builder/agent-node.tsx
  - app/components/pipeline-builder/trait-chip.tsx
  - app/routes/pipelines.new.tsx
  - app/routes/pipelines.$id.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag a trait from sidebar to any agent node"
    - "Trait appears as colored chip on agent node after drop"
    - "Same trait can be on multiple agents in the pipeline"
    - "Dropping duplicate trait on same agent is silently ignored"
    - "User can remove a trait chip from an agent node"
  artifacts:
    - path: "app/components/pipeline-builder/trait-chip.tsx"
      provides: "Colored chip component for displaying traits on nodes"
      exports: ["TraitChip"]
    - path: "app/components/pipeline-builder/agent-node.tsx"
      provides: "Agent node with drag-over detection and trait chip rendering"
      contains: "handleDrop"
  key_links:
    - from: "app/components/pipeline-builder/agent-node.tsx"
      to: "app/stores/pipeline-store.ts"
      via: "usePipelineStore().addTraitToNode"
      pattern: "addTraitToNode"
    - from: "app/components/pipeline-builder/agent-node.tsx"
      to: "app/components/pipeline-builder/trait-chip.tsx"
      via: "TraitChip import"
      pattern: "TraitChip"
---

<objective>
Enable trait drop on agent nodes and display assigned traits as colored chips

Purpose: Core interaction - users drop traits onto agents, see visual feedback, and can remove them
Output: Working drag-drop onto nodes, trait chips displayed with colors, remove functionality
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-dynamic-pipeline-traits/17-RESEARCH.md
@.planning/phases/17-dynamic-pipeline-traits/17-01-SUMMARY.md

@app/components/pipeline-builder/agent-node.tsx
@app/stores/pipeline-store.ts
@app/lib/trait-colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TraitChip component</name>
  <files>app/components/pipeline-builder/trait-chip.tsx</files>
  <action>
Create a small chip component for displaying traits on agent nodes:

```typescript
import { X } from "lucide-react";
import { cn } from "~/lib/utils";

interface TraitChipProps {
  id: string;
  name: string;
  color: string;
  onRemove?: (id: string) => void;
}

export function TraitChip({ id, name, color, onRemove }: TraitChipProps) {
  return (
    <span
      className={cn(
        "inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium text-white",
        "max-w-[100px] truncate"
      )}
      style={{ backgroundColor: color }}
      title={name}
    >
      <span className="truncate">{name}</span>
      {onRemove && (
        <button
          type="button"
          onClick={(e) => {
            e.stopPropagation();
            onRemove(id);
          }}
          className="flex-shrink-0 hover:bg-white/20 rounded-full p-0.5"
          aria-label={`Remove ${name} trait`}
        >
          <X className="w-3 h-3" />
        </button>
      )}
    </span>
  );
}
```

Key points:
- Use inline backgroundColor for dynamic color (Tailwind can't handle runtime values)
- Include truncation for long names with title tooltip
- X button for removal with stopPropagation to prevent node selection
- Small size to fit multiple chips without overwhelming the node
  </action>
  <verify>TypeScript compiles: `npm run typecheck`</verify>
  <done>TraitChip component exists with color display and remove functionality</done>
</task>

<task type="auto">
  <name>Task 2: Add drag-drop handling and trait display to AgentNode</name>
  <files>app/components/pipeline-builder/agent-node.tsx, app/routes/pipelines.new.tsx, app/routes/pipelines.$id.tsx</files>
  <action>
Update AgentNode to:
1. Accept traits data via React Flow node data (for rendering chip names/colors)
2. Handle dragOver/drop events for traits
3. Display trait chips below the agent content
4. Support trait removal

First, modify the routes to pass full trait objects to AgentNode via a React context or prop. The cleanest approach: store trait lookup map in the component that renders PipelineCanvas.

In pipelines.new.tsx and pipelines.$id.tsx:
- Create a TraitsContext that provides a Map<traitId, Trait>
- Wrap PipelineCanvas with this context
- AgentNode reads from context to get trait details

Create a simple context (can be in agent-node.tsx or a separate file):
```typescript
// In agent-node.tsx or a new context file
import { createContext, useContext } from "react";
import type { Trait } from "~/db/schema/traits";

export const TraitsContext = createContext<Map<string, Trait>>(new Map());
export const useTraits = () => useContext(TraitsContext);
```

Update AgentNode component:
```typescript
import { memo, useState } from "react";
import { Handle, Position, type Node, type NodeProps } from "@xyflow/react";
import { Card, CardHeader, CardTitle, CardContent } from "~/components/ui/card";
import { Unplug } from "lucide-react";
import { cn } from "~/lib/utils";
import type { AgentNodeData } from "~/stores/pipeline-store";
import { usePipelineStore } from "~/stores/pipeline-store";
import { TraitChip } from "./trait-chip";
import { TraitsContext, useTraits } from "./traits-context";

type AgentNodeType = Node<AgentNodeData, "agent">;

export const AgentNode = memo(
  ({ id, data, selected }: NodeProps<AgentNodeType>) => {
    const { addTraitToNode, removeTraitFromNode } = usePipelineStore();
    const traitsMap = useTraits();
    const [isDragOver, setIsDragOver] = useState(false);

    const handleDragOver = (event: React.DragEvent) => {
      // Only accept trait drops, not agent drops
      if (event.dataTransfer.types.includes("application/trait-id")) {
        event.preventDefault();
        event.dataTransfer.dropEffect = "copy";
        setIsDragOver(true);
      }
    };

    const handleDragLeave = () => {
      setIsDragOver(false);
    };

    const handleDrop = (event: React.DragEvent) => {
      event.preventDefault();
      event.stopPropagation(); // Prevent canvas drop handler
      setIsDragOver(false);

      const traitId = event.dataTransfer.getData("application/trait-id");
      if (traitId) {
        addTraitToNode(id, traitId);
      }
    };

    const handleRemoveTrait = (traitId: string) => {
      removeTraitFromNode(id, traitId);
    };

    // Get trait details for display (filter out any deleted traits)
    const nodeTraits = (data.traitIds || [])
      .map((traitId) => traitsMap.get(traitId))
      .filter((trait): trait is Trait => trait !== undefined);

    return (
      <Card
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
        className={cn(
          "w-[250px] py-0",
          selected && "ring-2 ring-primary",
          isDragOver && "ring-2 ring-primary/50 bg-primary/5",
          data.isOrphaned && "opacity-70 border-destructive/50 bg-destructive/5"
        )}
      >
        <Handle
          type="target"
          position={Position.Left}
          className="!bg-muted-foreground !w-3 !h-3"
        />
        <CardHeader className="py-3 px-4">
          <CardTitle className="text-sm font-medium flex items-center gap-2">
            {data.isOrphaned && (
              <Unplug className="w-3.5 h-3.5 text-destructive flex-shrink-0" />
            )}
            {data.agentName}
          </CardTitle>
        </CardHeader>
        {data.agentInstructions && (
          <CardContent className="py-2 px-4 pt-0">
            <p className="text-xs text-muted-foreground line-clamp-2">
              {data.agentInstructions}
            </p>
          </CardContent>
        )}
        {nodeTraits.length > 0 && (
          <div className="flex flex-wrap gap-1 px-4 pb-3">
            {nodeTraits.map((trait) => (
              <TraitChip
                key={trait.id}
                id={trait.id}
                name={trait.name}
                color={trait.color}
                onRemove={handleRemoveTrait}
              />
            ))}
          </div>
        )}
        <Handle
          type="source"
          position={Position.Right}
          className="!bg-muted-foreground !w-3 !h-3"
        />
      </Card>
    );
  }
);

AgentNode.displayName = "AgentNode";
```

Create traits-context.tsx file:
```typescript
import { createContext, useContext } from "react";
import type { Trait } from "~/db/schema/traits";

export const TraitsContext = createContext<Map<string, Trait>>(new Map());
export const useTraits = () => useContext(TraitsContext);
```

Update pipelines.new.tsx and pipelines.$id.tsx to wrap with TraitsContext:
```tsx
import { TraitsContext } from "~/components/pipeline-builder/traits-context";

// In component:
const traitsMap = useMemo(
  () => new Map(traits.map((t) => [t.id, t])),
  [traits]
);

// Wrap PipelineCanvas:
<TraitsContext.Provider value={traitsMap}>
  <PipelineCanvas onDropAgent={handleDropAgent} />
</TraitsContext.Provider>
```

Import useMemo from React if not already imported.
  </action>
  <verify>
1. `npm run typecheck` passes
2. Start dev server, navigate to /pipelines/new
3. Drag a trait from sidebar to an agent node
4. Verify trait appears as colored chip on the node
5. Verify drag-over shows visual highlight (ring)
6. Click X on chip to remove trait
7. Drop same trait twice - should only appear once (Set deduplication)
8. Drop same trait on different agents - should appear on both
  </verify>
  <done>Traits can be dropped on agent nodes, display as colored chips, and can be removed</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck`
2. Dev server starts: `npm run dev`
3. Create a pipeline with 2+ agents
4. Drag a trait to first agent - chip appears
5. Drag same trait to second agent - chip appears on both
6. Drag same trait to first agent again - only one chip (deduplication)
7. Click X on chip - trait removed from that node
8. Node highlights on drag-over with trait
</verification>

<success_criteria>
- TraitChip component renders colored badge with name and remove button
- AgentNode accepts trait drops (not agent drops)
- AgentNode shows visual feedback on drag-over
- Dropped traits appear as chips with correct color
- Same trait can be on multiple agents (PIPE-05)
- Duplicate drops are silently deduplicated (PIPE-06)
- X button removes trait from node
- TraitsContext provides trait lookup for rendering
</success_criteria>

<output>
After completion, create `.planning/phases/17-dynamic-pipeline-traits/17-02-SUMMARY.md`
</output>
