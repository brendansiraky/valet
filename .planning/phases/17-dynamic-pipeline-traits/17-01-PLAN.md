---
phase: 17-dynamic-pipeline-traits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/stores/pipeline-store.ts
  - app/components/pipeline-builder/agent-sidebar.tsx
  - app/routes/pipelines.new.tsx
  - app/routes/pipelines.$id.tsx
autonomous: true

must_haves:
  truths:
    - "Pipeline builder sidebar shows Agents section and Traits section"
    - "Traits are draggable from sidebar"
    - "Dragging a trait sets application/trait-id in dataTransfer"
  artifacts:
    - path: "app/stores/pipeline-store.ts"
      provides: "traitIds in AgentNodeData, addTraitToNode and removeTraitFromNode actions"
      contains: "traitIds"
    - path: "app/components/pipeline-builder/agent-sidebar.tsx"
      provides: "Combined sidebar with Agents and Traits sections"
      contains: "application/trait-id"
  key_links:
    - from: "app/components/pipeline-builder/agent-sidebar.tsx"
      to: "app/stores/pipeline-store.ts"
      via: "dataTransfer with trait-id"
      pattern: "application/trait-id"
---

<objective>
Extend pipeline store with trait support and transform sidebar to show both Agents and Traits sections

Purpose: Foundation for drag-and-drop trait assignment - store must track traitIds per node and sidebar must provide draggable traits
Output: Extended store with trait actions, sidebar with both sections, traits section draggable
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-dynamic-pipeline-traits/17-RESEARCH.md

@app/stores/pipeline-store.ts
@app/components/pipeline-builder/agent-sidebar.tsx
@app/db/schema/traits.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend pipeline store with trait support</name>
  <files>app/stores/pipeline-store.ts</files>
  <action>
Modify AgentNodeData type to include traitIds array:
```typescript
export type AgentNodeData = {
  agentId: string;
  agentName: string;
  agentInstructions?: string;
  isOrphaned?: boolean;
  traitIds: string[];  // Array of trait IDs assigned to this pipeline step
  [key: string]: unknown;
};
```

Add two new actions to PipelineState interface:
- `addTraitToNode: (nodeId: string, traitId: string) => void`
- `removeTraitFromNode: (nodeId: string, traitId: string) => void`

Implement addTraitToNode using Set deduplication:
```typescript
addTraitToNode: (nodeId, traitId) => {
  set({
    nodes: get().nodes.map((node) =>
      node.id === nodeId
        ? {
            ...node,
            data: {
              ...node.data,
              traitIds: [...new Set([...(node.data.traitIds || []), traitId])],
            },
          }
        : node
    ),
  });
},
```

Implement removeTraitFromNode:
```typescript
removeTraitFromNode: (nodeId, traitId) => {
  set({
    nodes: get().nodes.map((node) =>
      node.id === nodeId
        ? {
            ...node,
            data: {
              ...node.data,
              traitIds: (node.data.traitIds || []).filter((id) => id !== traitId),
            },
          }
        : node
    ),
  });
},
```

Update addAgentNode to initialize traitIds as empty array:
```typescript
data: {
  agentId: agent.id,
  agentName: agent.name,
  agentInstructions: agent.instructions,
  traitIds: [],  // Initialize empty trait array
},
```
  </action>
  <verify>TypeScript compiles without errors: `npm run typecheck`</verify>
  <done>Pipeline store has traitIds in node data and addTraitToNode/removeTraitFromNode actions with Set deduplication</done>
</task>

<task type="auto">
  <name>Task 2: Transform sidebar to show Agents and Traits sections</name>
  <files>app/components/pipeline-builder/agent-sidebar.tsx, app/routes/pipelines.new.tsx, app/routes/pipelines.$id.tsx</files>
  <action>
Update AgentSidebar component to accept traits prop alongside agents:
```typescript
import type { Agent } from "~/db/schema/agents";
import type { Trait } from "~/db/schema/traits";

interface PipelineBuilderSidebarProps {
  agents: Agent[];
  traits: Trait[];
}
```

Rename the component from AgentSidebar to keep the same file but update the export name to reflect dual purpose. Actually, keep the filename and component name as AgentSidebar for now to minimize changes - just add traits prop.

Add trait drag handler (similar to agent drag):
```typescript
const onTraitDragStart = (event: React.DragEvent, trait: Trait) => {
  event.dataTransfer.setData("application/trait-id", trait.id);
  event.dataTransfer.setData("application/trait-name", trait.name);
  event.dataTransfer.setData("application/trait-color", trait.color);
  event.dataTransfer.effectAllowed = "copy";
};
```

Update JSX to show two collapsible sections:
1. "Agents" section (existing content)
2. "Traits" section (new, below agents)

For the Traits section, render draggable cards with left border color:
```tsx
<h2 className="font-semibold mb-4 mt-6">Traits</h2>
{traits.length === 0 ? (
  <p className="text-sm text-muted-foreground">
    No traits yet. Create traits first.
  </p>
) : (
  <div className="space-y-2">
    {traits.map((trait) => (
      <Card
        key={trait.id}
        draggable
        onDragStart={(e) => onTraitDragStart(e, trait)}
        className="cursor-grab active:cursor-grabbing hover:border-primary transition-colors py-0"
        style={{ borderLeftWidth: '4px', borderLeftColor: trait.color }}
      >
        <CardHeader className="py-2 px-3">
          <CardTitle className="text-sm">{trait.name}</CardTitle>
        </CardHeader>
      </Card>
    ))}
  </div>
)}
```

Update pipelines.new.tsx and pipelines.$id.tsx routes to:
1. Load traits from database in loader (add to existing query)
2. Pass traits to AgentSidebar component

In loader, add traits query:
```typescript
const userTraits = await db
  .select()
  .from(traits)
  .where(eq(traits.userId, userId))
  .orderBy(traits.name);
```

Pass to component:
```tsx
<AgentSidebar agents={agents} traits={traits} />
```
  </action>
  <verify>
1. `npm run typecheck` passes
2. Start dev server, navigate to /pipelines/new
3. Verify sidebar shows "Your Agents" and "Traits" sections
4. Verify traits have left border in their assigned color
5. Verify traits are draggable (cursor changes to grab)
  </verify>
  <done>Sidebar shows both Agents and Traits sections, traits are draggable with correct dataTransfer values</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck`
2. Dev server starts: `npm run dev`
3. Navigate to /pipelines/new - sidebar shows Agents section AND Traits section
4. Traits display with colored left border
5. Dragging a trait shows grab cursor
6. (Inspect) Trait drag sets application/trait-id in dataTransfer
</verification>

<success_criteria>
- Pipeline store has `traitIds: string[]` in AgentNodeData type
- Pipeline store has `addTraitToNode` action with Set deduplication
- Pipeline store has `removeTraitFromNode` action
- New agent nodes initialize with empty `traitIds` array
- Sidebar shows "Agents" and "Traits" sections
- Traits are draggable with `application/trait-id` in dataTransfer
- Traits display their assigned color as left border
</success_criteria>

<output>
After completion, create `.planning/phases/17-dynamic-pipeline-traits/17-01-SUMMARY.md`
</output>
