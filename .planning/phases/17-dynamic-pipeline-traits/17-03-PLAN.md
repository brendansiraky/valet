---
phase: 17-dynamic-pipeline-traits
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - app/services/job-queue.server.ts
autonomous: true

must_haves:
  truths:
    - "Pipeline execution uses traits attached to each step (from node data)"
    - "Traits load from node.data.traitIds, not from agent_traits table"
    - "Deleted traits are gracefully skipped at runtime"
  artifacts:
    - path: "app/services/job-queue.server.ts"
      provides: "Pipeline execution with step-level trait loading"
      contains: "node.data.traitIds"
  key_links:
    - from: "app/services/job-queue.server.ts"
      to: "database traits table"
      via: "inArray query on traitIds"
      pattern: "inArray.*traits.id.*traitIds"
---

<objective>
Update pipeline execution to load traits from node data instead of agent_traits table

Purpose: Complete the data model shift - traits are now per-pipeline-step, not per-agent
Output: Pipeline runs use traits assigned in the pipeline builder, not agent-level associations
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-dynamic-pipeline-traits/17-RESEARCH.md
@.planning/phases/17-dynamic-pipeline-traits/17-02-SUMMARY.md

@app/services/job-queue.server.ts
@app/db/schema/traits.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update buildStepsFromFlow to load traits from node data</name>
  <files>app/services/job-queue.server.ts</files>
  <action>
Modify the `buildStepsFromFlow` function to load traits from `node.data.traitIds` instead of querying the `agent_traits` junction table.

1. Add import for traits table and inArray:
```typescript
import { db, pipelineRuns, pipelineRunSteps, agents, pipelines, apiKeys, traits } from "~/db";
import { and, eq, inArray } from "drizzle-orm";
```

2. Remove import of agentTraits (no longer needed for this function)

3. In the loop where we build steps, replace the agent_traits query with node data lookup:

BEFORE (current code):
```typescript
// Load trait assignments for this agent
const assignments = await db.query.agentTraits.findMany({
  where: eq(agentTraits.agentId, agent.id),
  with: { trait: { columns: { name: true, context: true } } },
});

const traitContext = assignments.length > 0
  ? assignments.map((a) => `## ${a.trait.name}\n\n${a.trait.context}`).join("\n\n---\n\n")
  : undefined;
```

AFTER (new code):
```typescript
// Load trait assignments from node data (pipeline-level, not agent-level)
const traitIds: string[] = node.data.traitIds ?? [];
let traitContext: string | undefined;

if (traitIds.length > 0) {
  const nodeTraits = await db
    .select({ name: traits.name, context: traits.context })
    .from(traits)
    .where(inArray(traits.id, traitIds));

  // Note: nodeTraits may have fewer items than traitIds if some traits were deleted
  // This gracefully handles deleted traits by simply not including them
  if (nodeTraits.length > 0) {
    traitContext = nodeTraits
      .map((t) => `## ${t.name}\n\n${t.context}`)
      .join("\n\n---\n\n");
  }
}
```

Key differences:
- Read trait IDs from `node.data.traitIds` (pipeline-level assignment)
- Use `inArray` query to fetch trait details by IDs
- Gracefully handle deleted traits (inArray will simply not return them)
- Same output format (`## Name\n\nContext` joined by `---`)

The agentTraits import can be removed from the file header since it's no longer used in this file. However, check if it's used elsewhere in the file first - if not, remove it.
  </action>
  <verify>
1. `npm run typecheck` passes
2. Start dev server
3. Create a pipeline with agents and traits assigned to steps
4. Run the pipeline
5. Check that trait context is included in agent prompts (visible in step output if traits modify behavior)
6. Delete a trait, run pipeline again - should not error, just skips deleted trait
  </verify>
  <done>Pipeline execution loads traits from node.data.traitIds, deleted traits are gracefully skipped</done>
</task>

<task type="auto">
  <name>Task 2: Verify and document migration from agent-level traits</name>
  <files>app/services/job-queue.server.ts</files>
  <action>
Add a code comment documenting the migration from agent-level to pipeline-level traits:

At the top of buildStepsFromFlow function, add:
```typescript
/**
 * Build PipelineStep array from React Flow graph using topological sort.
 * Uses Kahn's algorithm to ensure steps are ordered by dependencies.
 *
 * Trait Loading (v1.3+):
 * - Traits are loaded from node.data.traitIds (pipeline-level assignment)
 * - This replaced agent_traits table lookup (agent-level assignment)
 * - Same agent can have different traits in different pipelines
 * - Deleted traits are gracefully skipped (no error, just excluded)
 */
```

The agent_traits table still exists and may have data from before v1.3, but pipeline execution no longer uses it. A future cleanup phase could:
1. Add migration to remove agent_traits data
2. Drop the agent_traits table entirely
3. Remove the agentTraits schema definition

For now, leave the table in place as it doesn't cause harm - the UI no longer writes to it (Phase 15 removed trait selector from agent form), and execution no longer reads from it.
  </action>
  <verify>
1. Read the comment in job-queue.server.ts
2. Confirm agentTraits import is removed if not used elsewhere
3. `npm run typecheck` passes
  </verify>
  <done>Code documented, migration path clear, no breaking changes</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck`
2. Dev server starts: `npm run dev`
3. Create pipeline: Agent A, Agent B
4. Assign Trait X to Agent A only
5. Assign Trait Y to both agents
6. Run pipeline - Agent A gets Trait X + Y context, Agent B gets only Trait Y context
7. Delete Trait X, run pipeline again - should succeed, Agent A just gets Trait Y
8. Verify no errors in console related to missing traits
</verification>

<success_criteria>
- Pipeline execution reads traitIds from node.data (DATA-01 complete)
- Traits loaded via inArray query, not agent_traits join
- Deleted traits gracefully skipped (no error)
- Same agent in different pipelines can have different traits
- Code comments document the migration
- agentTraits import removed if not used
</success_criteria>

<output>
After completion, create `.planning/phases/17-dynamic-pipeline-traits/17-03-SUMMARY.md`
</output>
