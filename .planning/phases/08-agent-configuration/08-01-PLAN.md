---
phase: 08-agent-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/db/schema/agents.ts
  - app/db/schema/agent-traits.ts
  - app/db/index.ts
  - drizzle/0003_*.sql
autonomous: true

must_haves:
  truths:
    - "Agents table has capability column with default 'none'"
    - "Agents table has nullable model column"
    - "Agent-traits junction table exists with proper foreign keys"
    - "Cascade deletes work for both agent and trait deletions"
  artifacts:
    - path: "app/db/schema/agents.ts"
      provides: "capability and model columns, AgentCapability type"
      contains: "capability.*text.*notNull.*default"
    - path: "app/db/schema/agent-traits.ts"
      provides: "Junction table for agent-trait assignments"
      exports: ["agentTraits", "AgentTrait", "agentTraitsRelations"]
    - path: "app/db/index.ts"
      provides: "Export of agent-traits schema"
      contains: "agent-traits"
  key_links:
    - from: "app/db/schema/agent-traits.ts"
      to: "app/db/schema/agents.ts"
      via: "foreign key reference"
      pattern: "references.*agents\\.id"
    - from: "app/db/schema/agent-traits.ts"
      to: "app/db/schema/traits.ts"
      via: "foreign key reference"
      pattern: "references.*traits\\.id"
---

<objective>
Extend agent database schema with capability and model configuration, and create junction table for trait assignment.

Purpose: Database foundation for storing agent configuration (capability, model, assigned traits) enabling AGNT-07, AGNT-08, AGNT-09.
Output: Extended agents table and new agent_traits junction table with proper relations.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-agent-configuration/08-RESEARCH.md

@app/db/schema/agents.ts
@app/db/schema/traits.ts
@app/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend agents schema with capability and model columns</name>
  <files>app/db/schema/agents.ts</files>
  <action>
Add capability and model columns to the agents table:

1. Add capability column:
   - Type: text, not null, default "none"
   - Valid values: "none" | "search" | "fetch"

2. Add model column:
   - Type: text, nullable (null means use user's default from settings)

3. Add AgentCapability type export:
   ```typescript
   export type AgentCapability = "none" | "search" | "fetch";
   ```

Keep existing columns unchanged. The Agent type will automatically include the new fields.
  </action>
  <verify>TypeScript compiles: `cd /Users/brendan/code/valet && npx tsc --noEmit`</verify>
  <done>agents.ts has capability (text, notNull, default "none") and model (text, nullable) columns with AgentCapability type exported</done>
</task>

<task type="auto">
  <name>Task 2: Create agent-traits junction table with relations</name>
  <files>app/db/schema/agent-traits.ts, app/db/index.ts</files>
  <action>
Create new file app/db/schema/agent-traits.ts with:

1. Junction table `agentTraits`:
   - agentId: text, notNull, references agents.id with onDelete cascade
   - traitId: text, notNull, references traits.id with onDelete cascade
   - assignedAt: timestamp, defaultNow, notNull
   - Primary key: composite of (agentId, traitId)

2. Relations for Drizzle query with():
   - agentTraitsRelations: one-to-one with agents and traits
   - agentsRelations: one-to-many from agents to agentTraits
   - traitsRelations: one-to-many from traits to agentTraits

3. Type exports:
   - AgentTrait = typeof agentTraits.$inferSelect
   - NewAgentTrait = typeof agentTraits.$inferInsert

Update app/db/index.ts:
- Import agentTraits schema: `import * as agentTraits from "./schema/agent-traits";`
- Add to schema object: `...agentTraits`
- Export: `export * from "./schema/agent-traits";`

Note: Relations must be in the same file as the junction table for Drizzle to resolve them. Import agents and traits tables for the foreign key references.
  </action>
  <verify>TypeScript compiles: `cd /Users/brendan/code/valet && npx tsc --noEmit`</verify>
  <done>agent-traits.ts exists with junction table, relations, and types; db/index.ts exports the new schema</done>
</task>

<task type="auto">
  <name>Task 3: Generate and run database migration</name>
  <files>drizzle/0003_*.sql</files>
  <action>
Generate and apply database migration:

1. Generate migration:
   ```bash
   cd /Users/brendan/code/valet && npx drizzle-kit generate
   ```
   This creates a new migration file in drizzle/ directory.

2. Apply migration:
   ```bash
   cd /Users/brendan/code/valet && npx drizzle-kit push
   ```
   This applies the schema changes to the database.

Expected changes:
- ALTER TABLE agents ADD COLUMN capability text NOT NULL DEFAULT 'none'
- ALTER TABLE agents ADD COLUMN model text
- CREATE TABLE agent_traits with composite primary key

If migration fails due to existing data, ensure the DEFAULT 'none' handles existing rows.
  </action>
  <verify>Migration succeeds: `cd /Users/brendan/code/valet && npx drizzle-kit push` shows no pending changes</verify>
  <done>Migration file exists in drizzle/ and database schema is updated</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Migration applied successfully: `npx drizzle-kit push` shows no pending changes
3. New Agent type includes capability and model fields
4. agentTraits table has proper foreign keys to both agents and traits
</verification>

<success_criteria>
- agents table has capability (text, not null, default "none") column
- agents table has model (text, nullable) column
- agent_traits junction table exists with composite primary key
- Foreign keys cascade on delete for both agent and trait references
- All Drizzle relations defined for query with() support
</success_criteria>

<output>
After completion, create `.planning/phases/08-agent-configuration/08-01-SUMMARY.md`
</output>
