---
phase: 04-pipeline-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - app/db/schema/pipelines.ts
  - app/db/schema/index.ts
  - app/stores/pipeline-store.ts
  - drizzle/*.sql
autonomous: true

must_haves:
  truths:
    - "Pipeline and template tables exist in database"
    - "Zustand store provides flow state management for React Flow"
    - "React Flow and dagre dependencies are installed"
  artifacts:
    - path: "app/db/schema/pipelines.ts"
      provides: "Pipeline and template table definitions"
      contains: "pipelines"
    - path: "app/stores/pipeline-store.ts"
      provides: "Zustand store for flow state"
      exports: ["usePipelineStore"]
  key_links:
    - from: "app/db/schema/pipelines.ts"
      to: "app/db/schema/users.ts"
      via: "foreign key reference"
      pattern: "references.*users.id"
---

<objective>
Set up pipeline infrastructure: dependencies, database schema, and state management.

Purpose: Establish the foundation for the visual pipeline builder - database tables for persistence and Zustand store for React Flow state management.
Output: Installed dependencies, pipeline/template tables, and pipeline store ready for UI integration.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pipeline-builder/04-RESEARCH.md

Reference existing schema pattern:
@app/db/schema/agents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Flow and supporting dependencies</name>
  <files>package.json</files>
  <action>
Install required dependencies for the pipeline builder:
```bash
npm install @xyflow/react zustand dagre
npm install -D @types/dagre
```

Verify @xyflow/react version is 12.x (current stable).

Import React Flow CSS in app root. Add to app/root.tsx:
```typescript
import '@xyflow/react/dist/style.css';
```
  </action>
  <verify>
Run `npm ls @xyflow/react` - should show version 12.x
Run `npm ls zustand` - should show installed
Run `npm ls dagre` - should show installed
Check app/root.tsx contains React Flow CSS import
  </verify>
  <done>All dependencies installed; React Flow CSS imported in app root</done>
</task>

<task type="auto">
  <name>Task 2: Create pipeline database schema</name>
  <files>app/db/schema/pipelines.ts, app/db/schema/index.ts</files>
  <action>
Create `app/db/schema/pipelines.ts` with two tables following existing patterns from agents.ts:

**pipelines table:**
- id: text primary key with UUID default
- userId: text with foreign key to users.id (cascade delete)
- name: text not null
- description: text (nullable)
- flowData: jsonb not null - stores React Flow state with typed structure:
  ```typescript
  {
    nodes: Array<{ id: string; type: string; position: { x: number; y: number }; data: unknown }>;
    edges: Array<{ id: string; source: string; target: string }>;
    viewport?: { x: number; y: number; zoom: number };
  }
  ```
- createdAt: timestamp with default now
- updatedAt: timestamp with default now and $onUpdateFn
- Index on userId

**pipelineTemplates table:**
- id: text primary key with UUID default
- pipelineId: text with foreign key to pipelines.id (cascade delete)
- variables: jsonb not null with typed array:
  ```typescript
  Array<{ name: string; description?: string; defaultValue?: string }>
  ```
- createdAt: timestamp with default now
- Index on pipelineId

Export types: Pipeline, NewPipeline, PipelineTemplate, NewPipelineTemplate

Add exports to app/db/schema/index.ts
  </action>
  <verify>
Run `npx drizzle-kit generate` - should create migration without errors
Check migration SQL contains CREATE TABLE for pipelines and pipeline_templates
  </verify>
  <done>Pipeline schema created with proper types, foreign keys, and indexes; migration generated</done>
</task>

<task type="auto">
  <name>Task 3: Create Zustand pipeline store</name>
  <files>app/stores/pipeline-store.ts</files>
  <action>
Create `app/stores/pipeline-store.ts` following the pattern from RESEARCH.md:

```typescript
import { create } from 'zustand';
import {
  applyNodeChanges,
  applyEdgeChanges,
  addEdge,
  type Node,
  type Edge,
  type OnNodesChange,
  type OnEdgesChange,
  type OnConnect,
} from '@xyflow/react';

// Type for agent node data
interface AgentNodeData {
  agentId: string;
  agentName: string;
  agentInstructions?: string;
}

interface PipelineState {
  // Current pipeline metadata
  pipelineId: string | null;
  pipelineName: string;
  pipelineDescription: string;

  // React Flow state
  nodes: Node<AgentNodeData>[];
  edges: Edge[];

  // React Flow callbacks
  onNodesChange: OnNodesChange<Node<AgentNodeData>>;
  onEdgesChange: OnEdgesChange;
  onConnect: OnConnect;

  // Actions
  setNodes: (nodes: Node<AgentNodeData>[]) => void;
  setEdges: (edges: Edge[]) => void;
  addAgentNode: (agent: { id: string; name: string; instructions?: string }, position: { x: number; y: number }) => void;
  removeNode: (nodeId: string) => void;
  setPipelineMetadata: (id: string | null, name: string, description: string) => void;
  reset: () => void;
}

const initialState = {
  pipelineId: null,
  pipelineName: 'Untitled Pipeline',
  pipelineDescription: '',
  nodes: [],
  edges: [],
};

export const usePipelineStore = create<PipelineState>((set, get) => ({
  ...initialState,

  onNodesChange: (changes) => {
    set({ nodes: applyNodeChanges(changes, get().nodes) });
  },

  onEdgesChange: (changes) => {
    set({ edges: applyEdgeChanges(changes, get().edges) });
  },

  onConnect: (connection) => {
    set({ edges: addEdge(connection, get().edges) });
  },

  setNodes: (nodes) => set({ nodes }),
  setEdges: (edges) => set({ edges }),

  addAgentNode: (agent, position) => {
    const newNode: Node<AgentNodeData> = {
      id: crypto.randomUUID(),
      type: 'agent',
      position,
      data: {
        agentId: agent.id,
        agentName: agent.name,
        agentInstructions: agent.instructions,
      },
    };
    set({ nodes: [...get().nodes, newNode] });
  },

  removeNode: (nodeId) => {
    set({
      nodes: get().nodes.filter(n => n.id !== nodeId),
      edges: get().edges.filter(e => e.source !== nodeId && e.target !== nodeId),
    });
  },

  setPipelineMetadata: (id, name, description) => {
    set({ pipelineId: id, pipelineName: name, pipelineDescription: description });
  },

  reset: () => set(initialState),
}));
```

Ensure type safety with React Flow's generic Node type.
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass without type errors
Check store exports usePipelineStore
  </verify>
  <done>Zustand store created with typed agent nodes, flow callbacks, and pipeline metadata</done>
</task>

</tasks>

<verification>
1. Run `npm ls @xyflow/react zustand dagre` - all dependencies installed
2. Run `npx drizzle-kit generate` - migration exists for pipelines tables
3. Run `npx drizzle-kit push` - tables created in database
4. Run `npx tsc --noEmit` - no type errors
5. Import test: `import { usePipelineStore } from '@/stores/pipeline-store'` compiles
</verification>

<success_criteria>
- React Flow 12.x, Zustand, and dagre installed
- Pipeline and template tables created in database with proper indexes
- Zustand store exports usePipelineStore with typed flow state
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-pipeline-builder/04-01-SUMMARY.md`
</output>
