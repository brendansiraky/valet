---
phase: 04-pipeline-builder
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/routes/pipelines.tsx
  - app/routes/pipelines.$id.tsx
  - app/components/pipeline-builder/agent-node.tsx
  - app/components/pipeline-builder/pipeline-canvas.tsx
  - app/components/pipeline-builder/agent-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to pipelines page and see list"
    - "User can create a new pipeline and see the canvas"
    - "User can drag agents from sidebar onto canvas"
    - "Agents appear as nodes on the canvas when dropped"
    - "User can connect nodes by dragging between handles"
  artifacts:
    - path: "app/routes/pipelines.tsx"
      provides: "Pipeline list page"
      min_lines: 30
    - path: "app/routes/pipelines.$id.tsx"
      provides: "Pipeline builder canvas page"
      min_lines: 50
    - path: "app/components/pipeline-builder/agent-node.tsx"
      provides: "Custom React Flow node for agents"
      exports: ["AgentNode"]
    - path: "app/components/pipeline-builder/pipeline-canvas.tsx"
      provides: "React Flow canvas wrapper"
      exports: ["PipelineCanvas"]
    - path: "app/components/pipeline-builder/agent-sidebar.tsx"
      provides: "Draggable agent library sidebar"
      exports: ["AgentSidebar"]
  key_links:
    - from: "app/components/pipeline-builder/pipeline-canvas.tsx"
      to: "app/stores/pipeline-store.ts"
      via: "Zustand store import"
      pattern: "usePipelineStore"
    - from: "app/components/pipeline-builder/agent-sidebar.tsx"
      to: "app/components/pipeline-builder/pipeline-canvas.tsx"
      via: "HTML5 drag/drop data transfer"
      pattern: "dataTransfer.setData"
---

<objective>
Build the visual pipeline canvas UI with drag-and-drop agent placement.

Purpose: Create the core visual builder experience - users see their agents, drag them onto a canvas, and connect them to form pipelines.
Output: Working pipeline builder page with agent nodes, drag-drop from sidebar, and connection handles.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pipeline-builder/04-RESEARCH.md
@.planning/phases/04-pipeline-builder/04-01-SUMMARY.md

Reference existing route patterns:
@app/routes/agents.tsx
@app/routes/dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AgentNode component</name>
  <files>app/components/pipeline-builder/agent-node.tsx</files>
  <action>
Create `app/components/pipeline-builder/agent-node.tsx` - custom React Flow node for displaying agents:

```typescript
import { memo } from 'react';
import { Handle, Position, type NodeProps } from '@xyflow/react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';

interface AgentNodeData {
  agentId: string;
  agentName: string;
  agentInstructions?: string;
}

// IMPORTANT: Export the component for use in nodeTypes object
export const AgentNode = memo(({ data, selected }: NodeProps<AgentNodeData>) => {
  return (
    <Card className={`w-[250px] ${selected ? 'ring-2 ring-primary' : ''}`}>
      <Handle
        type="target"
        position={Position.Left}
        className="!bg-muted-foreground !w-3 !h-3"
      />
      <CardHeader className="py-3 px-4">
        <CardTitle className="text-sm font-medium">{data.agentName}</CardTitle>
      </CardHeader>
      {data.agentInstructions && (
        <CardContent className="py-2 px-4 pt-0">
          <p className="text-xs text-muted-foreground line-clamp-2">
            {data.agentInstructions}
          </p>
        </CardContent>
      )}
      <Handle
        type="source"
        position={Position.Right}
        className="!bg-muted-foreground !w-3 !h-3"
      />
    </Card>
  );
});

AgentNode.displayName = 'AgentNode';
```

Style handles with Tailwind for visibility. Use Card components from shadcn/ui.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors
Component exports AgentNode
  </verify>
  <done>AgentNode component created with handles and card styling</done>
</task>

<task type="auto">
  <name>Task 2: Create PipelineCanvas and AgentSidebar components</name>
  <files>app/components/pipeline-builder/pipeline-canvas.tsx, app/components/pipeline-builder/agent-sidebar.tsx</files>
  <action>
Create `app/components/pipeline-builder/pipeline-canvas.tsx`:

```typescript
import { useCallback } from 'react';
import {
  ReactFlow,
  Background,
  Controls,
  MiniMap,
  ReactFlowProvider,
} from '@xyflow/react';
import { usePipelineStore } from '@/stores/pipeline-store';
import { AgentNode } from './agent-node';

// CRITICAL: Define nodeTypes OUTSIDE component to prevent infinite re-renders
const nodeTypes = {
  agent: AgentNode,
};

interface PipelineCanvasProps {
  onDropAgent: (agentId: string, agentName: string, instructions: string | undefined, position: { x: number; y: number }) => void;
}

function PipelineCanvasInner({ onDropAgent }: PipelineCanvasProps) {
  const { nodes, edges, onNodesChange, onEdgesChange, onConnect } = usePipelineStore();

  const onDragOver = useCallback((event: React.DragEvent) => {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
  }, []);

  const onDrop = useCallback((event: React.DragEvent) => {
    event.preventDefault();

    const agentId = event.dataTransfer.getData('application/agent-id');
    const agentName = event.dataTransfer.getData('application/agent-name');
    const agentInstructions = event.dataTransfer.getData('application/agent-instructions');

    if (!agentId) return;

    // Get the ReactFlow instance to convert screen coordinates
    const reactFlowBounds = event.currentTarget.getBoundingClientRect();
    const position = {
      x: event.clientX - reactFlowBounds.left,
      y: event.clientY - reactFlowBounds.top,
    };

    onDropAgent(agentId, agentName, agentInstructions || undefined, position);
  }, [onDropAgent]);

  return (
    <div className="h-full w-full">
      <ReactFlow
        nodes={nodes}
        edges={edges}
        nodeTypes={nodeTypes}
        onNodesChange={onNodesChange}
        onEdgesChange={onEdgesChange}
        onConnect={onConnect}
        onDragOver={onDragOver}
        onDrop={onDrop}
        fitView
        className="bg-muted/30"
      >
        <Background />
        <Controls />
        <MiniMap />
      </ReactFlow>
    </div>
  );
}

// Wrap with provider for hooks to work
export function PipelineCanvas(props: PipelineCanvasProps) {
  return (
    <ReactFlowProvider>
      <PipelineCanvasInner {...props} />
    </ReactFlowProvider>
  );
}
```

Create `app/components/pipeline-builder/agent-sidebar.tsx`:

```typescript
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import type { Agent } from '@/db/schema/agents';

interface AgentSidebarProps {
  agents: Agent[];
}

export function AgentSidebar({ agents }: AgentSidebarProps) {
  const onDragStart = (event: React.DragEvent, agent: Agent) => {
    event.dataTransfer.setData('application/agent-id', agent.id);
    event.dataTransfer.setData('application/agent-name', agent.name);
    event.dataTransfer.setData('application/agent-instructions', agent.instructions || '');
    event.dataTransfer.effectAllowed = 'move';
  };

  return (
    <div className="w-64 border-r bg-background p-4 overflow-y-auto">
      <h2 className="font-semibold mb-4">Your Agents</h2>
      {agents.length === 0 ? (
        <p className="text-sm text-muted-foreground">
          No agents yet. Create agents first.
        </p>
      ) : (
        <div className="space-y-2">
          {agents.map((agent) => (
            <Card
              key={agent.id}
              draggable
              onDragStart={(e) => onDragStart(e, agent)}
              className="cursor-grab active:cursor-grabbing hover:border-primary transition-colors"
            >
              <CardHeader className="py-2 px-3">
                <CardTitle className="text-sm">{agent.name}</CardTitle>
              </CardHeader>
              <CardContent className="py-1 px-3 pb-2">
                <p className="text-xs text-muted-foreground line-clamp-1">
                  {agent.instructions}
                </p>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}
```

Key points:
- nodeTypes defined OUTSIDE component (React Flow pitfall #1)
- ReactFlowProvider wraps the inner component
- HTML5 drag/drop with custom MIME types
- Sidebar cards are draggable
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors
Both components export correctly
  </verify>
  <done>PipelineCanvas and AgentSidebar components created with drag-drop wiring</done>
</task>

<task type="auto">
  <name>Task 3: Create pipeline routes</name>
  <files>app/routes/pipelines.tsx, app/routes/pipelines.$id.tsx</files>
  <action>
Create `app/routes/pipelines.tsx` - pipeline list page:

```typescript
import { Link, useLoaderData } from 'react-router';
import type { Route } from './+types/pipelines';
import { db } from '@/db';
import { pipelines } from '@/db/schema';
import { eq } from 'drizzle-orm';
import { requireUser } from '@/lib/auth/session.server';
import { Button } from '@/components/ui/button';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Plus } from 'lucide-react';

export async function loader({ request }: Route.LoaderArgs) {
  const user = await requireUser(request);

  const userPipelines = await db
    .select()
    .from(pipelines)
    .where(eq(pipelines.userId, user.id))
    .orderBy(pipelines.updatedAt);

  return { pipelines: userPipelines };
}

export default function PipelinesPage() {
  const { pipelines } = useLoaderData<typeof loader>();

  return (
    <div className="container mx-auto py-8">
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-3xl font-bold">Pipelines</h1>
          <p className="text-muted-foreground">
            Create and manage your agent pipelines
          </p>
        </div>
        <Button asChild>
          <Link to="/pipelines/new">
            <Plus className="w-4 h-4 mr-2" />
            New Pipeline
          </Link>
        </Button>
      </div>

      {pipelines.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center">
            <p className="text-muted-foreground mb-4">
              You haven't created any pipelines yet.
            </p>
            <Button asChild>
              <Link to="/pipelines/new">Create your first pipeline</Link>
            </Button>
          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {pipelines.map((pipeline) => (
            <Card key={pipeline.id} className="hover:border-primary transition-colors">
              <Link to={`/pipelines/${pipeline.id}`}>
                <CardHeader>
                  <CardTitle>{pipeline.name}</CardTitle>
                  {pipeline.description && (
                    <CardDescription>{pipeline.description}</CardDescription>
                  )}
                </CardHeader>
                <CardContent>
                  <p className="text-xs text-muted-foreground">
                    Updated {new Date(pipeline.updatedAt).toLocaleDateString()}
                  </p>
                </CardContent>
              </Link>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}
```

Create `app/routes/pipelines.$id.tsx` - pipeline builder page:

```typescript
import { useLoaderData } from 'react-router';
import { useEffect } from 'react';
import type { Route } from './+types/pipelines.$id';
import { db } from '@/db';
import { pipelines } from '@/db/schema';
import { agents } from '@/db/schema';
import { eq, and } from 'drizzle-orm';
import { requireUser } from '@/lib/auth/session.server';
import { usePipelineStore } from '@/stores/pipeline-store';
import { PipelineCanvas } from '@/components/pipeline-builder/pipeline-canvas';
import { AgentSidebar } from '@/components/pipeline-builder/agent-sidebar';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';

export async function loader({ request, params }: Route.LoaderArgs) {
  const user = await requireUser(request);
  const { id } = params;

  // Fetch user's agents for sidebar
  const userAgents = await db
    .select()
    .from(agents)
    .where(eq(agents.userId, user.id));

  // For new pipelines, return null pipeline
  if (id === 'new') {
    return { pipeline: null, agents: userAgents };
  }

  // Load existing pipeline
  const [pipeline] = await db
    .select()
    .from(pipelines)
    .where(and(eq(pipelines.id, id), eq(pipelines.userId, user.id)));

  if (!pipeline) {
    throw new Response('Pipeline not found', { status: 404 });
  }

  return { pipeline, agents: userAgents };
}

export default function PipelineBuilderPage() {
  const { pipeline, agents: userAgents } = useLoaderData<typeof loader>();
  const {
    pipelineName,
    setPipelineMetadata,
    addAgentNode,
    setNodes,
    setEdges,
    reset,
  } = usePipelineStore();

  // Initialize store from loaded pipeline or reset for new
  useEffect(() => {
    if (pipeline) {
      setPipelineMetadata(pipeline.id, pipeline.name, pipeline.description || '');
      const flowData = pipeline.flowData as { nodes: any[]; edges: any[] };
      setNodes(flowData.nodes || []);
      setEdges(flowData.edges || []);
    } else {
      reset();
    }
  }, [pipeline, setPipelineMetadata, setNodes, setEdges, reset]);

  const handleDropAgent = (
    agentId: string,
    agentName: string,
    agentInstructions: string | undefined,
    position: { x: number; y: number }
  ) => {
    addAgentNode(
      { id: agentId, name: agentName, instructions: agentInstructions },
      position
    );
  };

  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setPipelineMetadata(pipeline?.id || null, e.target.value, pipeline?.description || '');
  };

  return (
    <div className="h-[calc(100vh-4rem)] flex flex-col">
      {/* Header */}
      <div className="border-b p-4 flex items-center gap-4">
        <Input
          value={pipelineName}
          onChange={handleNameChange}
          placeholder="Pipeline name"
          className="max-w-xs font-semibold"
        />
        <div className="flex-1" />
        <Button variant="outline" disabled>
          Save (coming soon)
        </Button>
      </div>

      {/* Main content */}
      <div className="flex-1 flex">
        <AgentSidebar agents={userAgents} />
        <div className="flex-1">
          <PipelineCanvas onDropAgent={handleDropAgent} />
        </div>
      </div>
    </div>
  );
}
```

Add pipelines link to dashboard navigation (update dashboard.tsx or add to nav).
  </action>
  <verify>
Run `npm run dev` and navigate to /pipelines - should see list page
Navigate to /pipelines/new - should see canvas with sidebar
Drag agent from sidebar to canvas - should create node
Connect two nodes - should create edge
  </verify>
  <done>Pipeline routes created with list view and builder canvas; drag-drop working</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - no type errors
2. Navigate to /pipelines - see empty state or list
3. Click "New Pipeline" - see builder canvas
4. Sidebar shows user's agents
5. Drag agent to canvas - node appears
6. Drag another agent - second node appears
7. Connect nodes via handles - edge created
8. Nodes can be repositioned
</verification>

<success_criteria>
- Pipeline list page shows user's pipelines
- Builder page has sidebar with draggable agents
- Canvas accepts dropped agents and creates nodes
- Nodes display agent name and instructions preview
- Nodes can be connected via handles
- Canvas has background, controls, and minimap
</success_criteria>

<output>
After completion, create `.planning/phases/04-pipeline-builder/04-02-SUMMARY.md`
</output>
