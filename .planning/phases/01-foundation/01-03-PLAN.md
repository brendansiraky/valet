---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - app/routes/register.tsx
  - app/routes/login.tsx
  - app/routes/logout.tsx
  - app/routes/settings.tsx
  - app/routes/dashboard.tsx
  - app/components/ui/button.tsx
  - app/components/ui/input.tsx
  - app/components/ui/label.tsx
  - app/components/ui/card.tsx
  - app/components/ui/select.tsx
  - components.json
  - app/lib/utils.ts
autonomous: false

user_setup:
  - service: anthropic
    why: "API key for testing auth and model selection"
    env_vars:
      - name: "User's own Anthropic API key"
        source: "https://console.anthropic.com/settings/keys"
    dashboard_config: []

must_haves:
  truths:
    - "User can create an account with email and password"
    - "User can log in and remain authenticated across browser sessions"
    - "User can save their Anthropic API key (stored encrypted server-side)"
    - "User can select which Claude model to use for their agents"
    - "User can log out and session is destroyed"
  artifacts:
    - path: "app/routes/register.tsx"
      provides: "Registration form and action"
      exports: ["action", "default"]
    - path: "app/routes/login.tsx"
      provides: "Login form and action"
      exports: ["action", "default"]
    - path: "app/routes/logout.tsx"
      provides: "Logout action"
      exports: ["action"]
    - path: "app/routes/settings.tsx"
      provides: "API key management and model selection"
      exports: ["loader", "action", "default"]
    - path: "app/routes/dashboard.tsx"
      provides: "Protected dashboard route"
      exports: ["loader", "default"]
  key_links:
    - from: "app/routes/login.tsx"
      to: "app/services/auth.server.ts"
      via: "authenticator.authenticate"
      pattern: "authenticator\\.authenticate"
    - from: "app/routes/register.tsx"
      to: "app/services/password.server.ts"
      via: "hashPassword"
      pattern: "hashPassword"
    - from: "app/routes/settings.tsx"
      to: "app/services/encryption.server.ts"
      via: "encrypt for API key storage"
      pattern: "encrypt\\("
---

<objective>
Create all authentication routes (register, login, logout) and the settings page for API key management and model selection.

Purpose: Complete the user-facing authentication flow so users can sign up, log in, manage their API keys, and select their preferred Claude model.
Output: Working authentication system with UI that satisfies all AUTH requirements.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up shadcn/ui and create auth routes</name>
  <files>
    components.json
    app/lib/utils.ts
    app/components/ui/button.tsx
    app/components/ui/input.tsx
    app/components/ui/label.tsx
    app/components/ui/card.tsx
    app/routes/register.tsx
    app/routes/login.tsx
    app/routes/logout.tsx
    app/routes/dashboard.tsx
  </files>
  <action>
Initialize shadcn/ui for Remix:
```bash
npx shadcn@latest init
```
When prompted:
- Style: Default
- Base color: Slate
- CSS variables: Yes
- Tailwind config: tailwind.config.ts
- Components: app/components
- Utils: app/lib/utils

Add required components:
```bash
npx shadcn@latest add button input label card
```

Create app/routes/register.tsx:
- loader: If already logged in (session has userId), redirect to /dashboard
- action: Validate email/password with Zod, check email not taken, hash password, create user, create session, redirect to /dashboard
- UI: Card with email input, password input, confirm password input, submit button, link to /login

Email validation: valid email format, lowercase before storing
Password validation: minimum 8 characters
Confirm password: must match password

CRITICAL: All mutations in action function only (CSRF protection).

Create app/routes/login.tsx:
- loader: If already logged in, redirect to /dashboard
- action: Use authenticator.authenticate("user-pass", request), on success set session userId and redirect to /dashboard, on failure flash error and redirect back
- UI: Card with email input, password input, submit button, link to /register

Follow RESEARCH.md Login Route Action pattern exactly.

Create app/routes/logout.tsx:
- action only (no loader, no UI) - Remix will POST to this
- Destroy session and redirect to /login

Create app/routes/dashboard.tsx:
- loader: Check session for userId, if not present redirect to /login, if present fetch user and return
- UI: Simple welcome message with user email, link to /settings, logout button (Form with POST to /logout)

This is a protected route that proves auth is working.
  </action>
  <verify>
1. Visit /register - form displays
2. Submit valid registration - redirects to /dashboard
3. Visit /login while logged in - redirects to /dashboard
4. Click logout - redirects to /login
5. Visit /dashboard while logged out - redirects to /login
6. Submit /login with valid credentials - redirects to /dashboard
7. Submit /login with invalid credentials - shows error, stays on login
  </verify>
  <done>
Registration creates user with hashed password. Login validates credentials and creates session. Logout destroys session. Dashboard is protected. All redirects work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create settings page with API key management</name>
  <files>
    app/components/ui/select.tsx
    app/routes/settings.tsx
    app/services/anthropic.server.ts
  </files>
  <action>
Add select component:
```bash
npx shadcn@latest add select
```

Create app/services/anthropic.server.ts:
```typescript
import Anthropic from "@anthropic-ai/sdk";
import { decrypt } from "./encryption.server";

export function createAnthropicClient(encryptedApiKey: string): Anthropic {
  const apiKey = decrypt(encryptedApiKey);
  return new Anthropic({ apiKey });
}

export const AVAILABLE_MODELS = [
  { id: "claude-sonnet-4-5-20250929", name: "Claude Sonnet 4.5 (Latest)" },
  { id: "claude-3-5-sonnet-20241022", name: "Claude 3.5 Sonnet" },
  { id: "claude-3-5-haiku-20241022", name: "Claude 3.5 Haiku (Fast)" },
  { id: "claude-3-opus-20240229", name: "Claude 3 Opus" },
] as const;

export type ModelId = typeof AVAILABLE_MODELS[number]["id"];

export async function validateApiKey(apiKey: string): Promise<boolean> {
  try {
    const client = new Anthropic({ apiKey });
    // Make a minimal API call to validate the key
    await client.messages.create({
      model: "claude-3-5-haiku-20241022",
      max_tokens: 1,
      messages: [{ role: "user", content: "hi" }],
    });
    return true;
  } catch {
    return false;
  }
}
```

Create app/routes/settings.tsx:
- loader: Require auth (redirect to /login if not logged in), fetch user's API key record if exists (do NOT return decrypted key to client - just return hasApiKey: boolean and modelPreference)
- action: Handle two intents via hidden input:
  - intent="save-api-key": Validate API key format (starts with "sk-"), optionally validate against Anthropic API, encrypt and upsert to api_keys table
  - intent="update-model": Update modelPreference in api_keys table
- UI:
  - Card for API key: Input field (type="password"), save button. If hasApiKey, show "API key saved" with option to update
  - Card for model selection: Select dropdown with AVAILABLE_MODELS, save button. Only show if hasApiKey is true.
  - Back to dashboard link

API key validation flow:
1. User enters key
2. Action validates format (starts with "sk-")
3. Action makes test API call to validate key works
4. If valid, encrypt and store
5. If invalid, flash error

CRITICAL: Never return decrypted API key to client. Only store encrypted. Loader returns hasApiKey boolean, not the key itself.
  </action>
  <verify>
1. Visit /settings while logged in - page displays
2. Enter invalid API key format - shows validation error
3. Enter valid-format but fake key - shows "invalid API key" error (API validation fails)
4. Enter real Anthropic API key - saves successfully, shows "API key saved"
5. Model selector appears after API key saved
6. Select different model - saves successfully
7. Refresh page - settings persist (hasApiKey true, model selection retained)
  </verify>
  <done>
Settings page allows saving encrypted API key with validation. Model selection persists to database. API keys never exposed to client. Protected route requires authentication.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication system with registration, login, logout, and API key/model settings</what-built>
  <how-to-verify>
Test the complete auth flow:

1. Start the app: `npm run dev`
2. Visit http://localhost:5173/register
3. Create a new account with email and password
4. Verify you're redirected to /dashboard and see your email
5. Click "Settings" link
6. Enter your Anthropic API key and save
7. Verify "API key saved" message appears
8. Select a Claude model and save
9. Click logout
10. Verify you're redirected to /login
11. Log back in with your credentials
12. Visit /settings - verify API key shows as saved and model selection is preserved
13. Try visiting /dashboard in an incognito window - should redirect to /login

Expected:
- All navigation works
- Sessions persist across page refreshes
- API key is validated before saving
- Model preference persists
- Protected routes redirect to login when not authenticated
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 1, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. All routes render (register, login, dashboard, settings, logout)
3. Registration creates user in database (check with Drizzle Studio)
4. Login creates session in database
5. Logout removes session from database
6. API key stored encrypted in api_keys table
7. Model preference stored in api_keys table
8. All four AUTH requirements met
</verification>

<success_criteria>
- AUTH-01: User can create account with email/password (register route)
- AUTH-02: User can log in and maintain session (login route, sessions table)
- AUTH-03: User can save Anthropic API key encrypted (settings route, api_keys table)
- AUTH-04: User can select Claude model (settings route, modelPreference field)
- All protected routes redirect to login when unauthenticated
- All mutations happen in action functions (CSRF safe)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
