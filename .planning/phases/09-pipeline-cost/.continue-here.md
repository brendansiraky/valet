---
phase: 09-pipeline-cost
task: bugfix
total_tasks: N/A (post-verification bugfix)
status: in_progress
last_updated: 2026-01-29
---

<current_state>
Phase 9 was marked complete but during manual testing two bugs were found:
1. **FIXED**: 404 error for model `claude-3-5-haiku-20241022` - was an old model ID stored in the database API key's modelPreference. Fixed by updating the database row.
2. **IN PROGRESS**: Usage summary not appearing in OutputViewer modal after pipeline completion.

The usage summary bug was diagnosed: RunProgress component showed usage when status="completed", but immediately after completion, `currentRunId` was set to null which HIDES RunProgress. Then OutputViewer modal appears but didn't receive usage data.

**Fix applied** (3 files modified, not committed):
- `run-progress.tsx`: Updated onComplete callback to pass usage and model
- `pipelines.$id.tsx`: Capture and forward usage/model to OutputViewer
- `output-viewer.tsx`: Added usage summary display

However, user reports pipeline now stuck on "Connecting..." - likely HMR issue or job queue not processing. Dev server was restarted but user paused before re-testing.
</current_state>

<completed_work>
- Diagnosed 404 model error - old `claude-3-5-haiku-20241022` in database
- Fixed database: updated api_keys.model_preference to `claude-haiku-4-5-20251001`
- Diagnosed usage summary not appearing - data flow issue between components
- Fixed data flow: 3 files modified to pass usage from RunProgress â†’ OutputViewer
</completed_work>

<remaining_work>
1. Test the fix:
   - Hard refresh browser (Cmd+Shift+R)
   - Run a pipeline
   - Verify usage summary appears in OutputViewer modal

2. If "Connecting..." persists, debug:
   - Check browser Network tab for runId in POST response
   - Check SSE stream for events
   - Check server logs for pg-boss errors

3. Once working, commit the bugfix
</remaining_work>

<decisions_made>
- Usage summary moved from RunProgress (which disappears) to OutputViewer (which stays visible)
- onComplete callback extended to pass (finalOutput, stepOutputs, usage, model)
</decisions_made>

<blockers>
- Pipeline possibly stuck on "Connecting..." - needs testing after browser hard refresh
</blockers>

<context>
The fix is conceptually simple: the usage data was being emitted by the server and captured by RunProgress, but RunProgress was hidden the moment it would display the usage (because onComplete sets currentRunId=null). The fix passes usage through to OutputViewer where the user actually sees the results.

Files modified (uncommitted):
- app/components/output-viewer/output-viewer.tsx
- app/components/pipeline-runner/run-progress.tsx
- app/routes/pipelines.$id.tsx

Dev server was restarted and should be running on localhost:5173.
</context>

<next_action>
1. Hard refresh browser at http://localhost:5173
2. Navigate to a pipeline and click Run
3. If stuck on "Connecting...", check browser console and Network tab
4. If working, verify usage summary appears in the output modal
5. Once confirmed working, commit the bugfix:
   ```
   git add -A && git commit -m "fix: pass usage data to OutputViewer modal"
   ```
</next_action>
