---
phase: 02-agent-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/components/agent-card.tsx
  - app/components/agent-form-dialog.tsx
  - app/components/agent-delete-dialog.tsx
  - app/routes/agents.tsx
  - app/routes/dashboard.tsx

autonomous: true

must_haves:
  truths:
    - "User can view their list of saved agents"
    - "User can create a new agent with name and instructions"
    - "User can edit an existing agent's name and instructions"
    - "User can delete an agent"
    - "Agents persist across page refresh"
  artifacts:
    - path: "app/routes/agents.tsx"
      provides: "Agent list page with CRUD actions"
      exports: ["loader", "action", "default"]
    - path: "app/components/agent-card.tsx"
      provides: "Agent display card component"
    - path: "app/components/agent-form-dialog.tsx"
      provides: "Create/edit agent modal"
    - path: "app/components/agent-delete-dialog.tsx"
      provides: "Delete confirmation modal"
  key_links:
    - from: "app/routes/agents.tsx"
      to: "db.query.agents"
      via: "loader function"
      pattern: "db\\.query\\.agents"
    - from: "app/routes/agents.tsx"
      to: "db.insert|update|delete"
      via: "action function"
      pattern: "db\\.(insert|update|delete)\\(agents\\)"
    - from: "app/components/agent-form-dialog.tsx"
      to: "app/routes/agents.tsx"
      via: "Form submission with intent"
      pattern: 'name="intent"'
    - from: "app/routes/dashboard.tsx"
      to: "app/routes/agents.tsx"
      via: "Link navigation"
      pattern: 'to="/agents"'
---

<objective>
Build the complete agent management UI with CRUD operations

Purpose: Enable users to create, view, edit, and delete agents through an intuitive interface
Output: Working agents page with full CRUD, accessible from dashboard
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-management/02-RESEARCH.md

# Reference for established patterns
@app/routes/settings.tsx
@app/routes/dashboard.tsx
@app/db/schema/agents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent card and dialog components</name>
  <files>app/components/agent-card.tsx, app/components/agent-form-dialog.tsx, app/components/agent-delete-dialog.tsx</files>
  <action>
Create three components for agent management UI:

**1. app/components/agent-card.tsx**
Display a single agent with edit/delete actions:
- Props: `agent: { id: string; name: string; instructions: string; updatedAt: Date }`
- Card layout with CardHeader (name) and CardContent (truncated instructions, ~100 chars)
- Show "Updated X ago" using relative time
- Action buttons: Edit (pencil icon), Delete (trash icon)
- Edit button triggers AgentFormDialog
- Delete button triggers AgentDeleteDialog
- Use lucide-react icons (Pencil, Trash2)

**2. app/components/agent-form-dialog.tsx**
Modal form for create/edit:
- Props: `agent?: Agent` (undefined for create, populated for edit), `trigger: ReactNode`
- Controlled Dialog with open state
- Form with intent="create" or intent="update" hidden input
- If editing, include agentId hidden input
- Fields: name (Input, maxLength 100), instructions (Textarea, maxLength 10000)
- Default values from agent prop when editing
- Use useFetcher for form submission
- Close dialog on successful submit (check fetcher.state === "idle" && fetcher.data?.success)
- Display validation errors under fields (fetcher.data?.errors?.name, etc.)
- Submit button: "Create Agent" or "Save Changes"

**3. app/components/agent-delete-dialog.tsx**
Confirmation modal for delete:
- Props: `agent: { id: string; name: string }`, `trigger: ReactNode`
- AlertDialog with clear warning message
- Show agent name in description: "This will permanently delete '{agent.name}'"
- Cancel button and destructive Delete button
- Form posts to agents route with intent="delete" and agentId
- Use native Form (not fetcher) - redirect handles UI update

All components should:
- Import types from "~/db" for Agent type
- Follow shadcn/ui patterns from RESEARCH.md
- Be fully typed with TypeScript
  </action>
  <verify>
Run `pnpm tsc --noEmit` - no TypeScript errors.
Files exist at specified paths.
  </verify>
  <done>
- AgentCard displays agent info with edit/delete buttons
- AgentFormDialog creates/edits agents via modal form
- AgentDeleteDialog confirms deletion with AlertDialog
- All components typed, following established patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agents route with loader and action</name>
  <files>app/routes/agents.tsx</files>
  <action>
Create the agents list page with full CRUD:

**Loader:**
- Check session for userId, redirect to /login if not authenticated
- Verify user exists in database
- Query agents for this user, ordered by updatedAt desc
- Select only needed fields: id, name, instructions, updatedAt
- Return { agents } array

**Action:**
- Check session for userId, redirect to /login if not authenticated
- Parse formData for intent

Intent "create":
- Validate with Zod schema: name (1-100 chars), instructions (1-10000 chars)
- On validation error: return { errors: result.error.flatten().fieldErrors } with status 400
- Insert new agent with userId
- Return { success: true }

Intent "update":
- Get agentId from formData
- Validate name and instructions with same Zod schema
- On validation error: return errors
- Update agent WHERE id = agentId AND userId = userId (ownership check!)
- Return { success: true }

Intent "delete":
- Get agentId from formData
- Delete agent WHERE id = agentId AND userId = userId (ownership check!)
- Return { success: true }

**Component:**
- Page header: "My Agents" title with "Create Agent" button (opens AgentFormDialog)
- If no agents: empty state with prompt to create first agent
- If agents exist: grid of AgentCard components (responsive: 1 col mobile, 2 cols md, 3 cols lg)
- Use gap-4 or gap-6 for spacing

**Validation schema:**
```typescript
const AgentSchema = z.object({
  name: z.string().min(1, "Name is required").max(100, "Name must be 100 characters or less"),
  instructions: z.string().min(1, "Instructions are required").max(10000, "Instructions must be 10,000 characters or less"),
});
```

Follow patterns from settings.tsx for auth checks and form handling.
  </action>
  <verify>
1. `pnpm dev` - no errors
2. Visit http://localhost:5173/agents (should redirect to login if not authenticated)
3. Log in and visit /agents - see empty state
4. Create agent via dialog - appears in list
5. Edit agent - changes persist
6. Delete agent - removed from list
7. Refresh page - agents still there
  </verify>
  <done>
- /agents route accessible to authenticated users
- Create agent with validation works
- Edit agent with validation works
- Delete agent with confirmation works
- Agents persist in database
- Proper ownership checks on all mutations
  </done>
</task>

<task type="auto">
  <name>Task 3: Add agents link to dashboard</name>
  <files>app/routes/dashboard.tsx</files>
  <action>
Update dashboard to include navigation to agents:

1. Add a "My Agents" button/link above "Settings" in the CardContent
2. Use Button with variant="default" for primary prominence
3. Link to="/agents"
4. Keep existing Settings and Sign out buttons

The dashboard CardContent should now have:
- My Agents button (primary action)
- Settings button (secondary/outline)
- Sign out button (destructive)

This makes agents the primary feature from the dashboard, reflecting the app's core purpose.
  </action>
  <verify>
1. Visit http://localhost:5173/dashboard
2. See "My Agents" button prominently displayed
3. Click button - navigates to /agents
  </verify>
  <done>
- Dashboard shows "My Agents" as primary action
- Navigation to /agents works
- Dashboard layout remains clean and usable
  </done>
</task>

</tasks>

<verification>
Full user flow test:
1. Start app: `pnpm dev`
2. Log in with test account
3. Dashboard shows "My Agents" button
4. Click to navigate to /agents
5. See empty state for new user
6. Click "Create Agent" - dialog opens
7. Enter name and instructions, submit - agent appears
8. Click edit icon on agent - dialog opens with current values
9. Modify and save - changes reflected
10. Click delete icon - confirmation dialog appears
11. Confirm delete - agent removed
12. Refresh page - state persists correctly
</verification>

<success_criteria>
- [ ] /agents page displays user's agents
- [ ] Create agent via dialog works with validation
- [ ] Edit agent via dialog works with validation
- [ ] Delete agent with confirmation works
- [ ] All operations require authentication
- [ ] All mutations check user ownership
- [ ] Empty state shown when no agents
- [ ] Dashboard links to agents page
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-management/02-02-SUMMARY.md`
</output>
