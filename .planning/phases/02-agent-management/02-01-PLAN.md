---
phase: 02-agent-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/db/schema/agents.ts
  - app/db/index.ts
  - app/components/ui/dialog.tsx
  - app/components/ui/alert-dialog.tsx
  - app/components/ui/textarea.tsx

autonomous: true

must_haves:
  truths:
    - "Agents table exists in database with correct schema"
    - "Dialog, AlertDialog, and Textarea components are available"
  artifacts:
    - path: "app/db/schema/agents.ts"
      provides: "Agent table definition with user foreign key"
      contains: "pgTable"
    - path: "app/db/index.ts"
      provides: "Schema export including agents"
      contains: "agents"
    - path: "app/components/ui/dialog.tsx"
      provides: "Modal dialog component"
    - path: "app/components/ui/alert-dialog.tsx"
      provides: "Confirmation dialog component"
    - path: "app/components/ui/textarea.tsx"
      provides: "Multi-line text input component"
  key_links:
    - from: "app/db/schema/agents.ts"
      to: "app/db/schema/users.ts"
      via: "foreign key reference"
      pattern: "references.*users.id"
---

<objective>
Set up database schema for agents and install required UI components

Purpose: Establish the data layer and UI primitives needed for agent CRUD operations
Output: agents table in database, Dialog/AlertDialog/Textarea shadcn components installed
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brendan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-management/02-RESEARCH.md

# Existing patterns to follow
@app/db/schema/api-keys.ts
@app/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agents database schema</name>
  <files>app/db/schema/agents.ts, app/db/index.ts</files>
  <action>
Create the agents table following the established pattern from api-keys.ts:

1. Create `app/db/schema/agents.ts`:
   - id: text primary key with crypto.randomUUID() default
   - userId: text foreign key to users.id with cascade delete
   - name: text, not null (agent display name, 1-100 chars)
   - instructions: text, not null (natural language instructions, up to 10000 chars)
   - createdAt: timestamp with defaultNow()
   - updatedAt: timestamp with defaultNow() and $onUpdateFn
   - Add index on userId for query performance
   - Export Agent and NewAgent types using $inferSelect and $inferInsert

2. Update `app/db/index.ts`:
   - Import agents schema: `import * as agents from "./schema/agents"`
   - Add to drizzle schema object: `{ ...users, ...sessions, ...apiKeys, ...agents }`
   - Add export: `export * from "./schema/agents"`

3. Run migration: `pnpm drizzle-kit push`

Follow exact patterns from api-keys.ts for consistency.
  </action>
  <verify>
Run `pnpm drizzle-kit push` successfully.
Query database to confirm agents table exists:
`docker exec valet-db-1 psql -U valet -d valet -c "\d agents"`
  </verify>
  <done>
- agents table exists in PostgreSQL with all columns
- Foreign key to users with cascade delete
- Index on user_id column
- Agent/NewAgent types exported from app/db
  </done>
</task>

<task type="auto">
  <name>Task 2: Install shadcn UI components</name>
  <files>app/components/ui/dialog.tsx, app/components/ui/alert-dialog.tsx, app/components/ui/textarea.tsx</files>
  <action>
Install the three shadcn/ui components needed for agent management:

```bash
pnpm dlx shadcn@latest add dialog
pnpm dlx shadcn@latest add alert-dialog
pnpm dlx shadcn@latest add textarea
```

These components provide:
- Dialog: Modal container for create/edit forms (accessible, focus trap, escape key handling)
- AlertDialog: Confirmation modal for delete operations (proper ARIA, accessible)
- Textarea: Multi-line input for agent instructions

Accept all defaults when prompted. Components will be created in app/components/ui/.
  </action>
  <verify>
Confirm files exist:
- app/components/ui/dialog.tsx
- app/components/ui/alert-dialog.tsx
- app/components/ui/textarea.tsx

Run `pnpm tsc --noEmit` to verify no TypeScript errors.
  </verify>
  <done>
- Dialog component installed with DialogTrigger, DialogContent, DialogHeader, DialogTitle, DialogDescription exports
- AlertDialog component installed with AlertDialogAction, AlertDialogCancel, AlertDialogContent, etc.
- Textarea component installed
- All components pass TypeScript compilation
  </done>
</task>

</tasks>

<verification>
1. Database: `docker exec valet-db-1 psql -U valet -d valet -c "SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'agents';"` shows id, user_id, name, instructions, created_at, updated_at
2. Components: All three .tsx files exist in app/components/ui/
3. TypeScript: `pnpm tsc --noEmit` passes
4. Dev server: `pnpm dev` starts without errors
</verification>

<success_criteria>
- [ ] agents table exists in database
- [ ] Foreign key constraint to users table
- [ ] Index on user_id column
- [ ] Agent/NewAgent types available via `import { Agent, NewAgent } from "~/db"`
- [ ] Dialog, AlertDialog, Textarea components installed
- [ ] TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-management/02-01-SUMMARY.md`
</output>
