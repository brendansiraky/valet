---
quick: 007
status: in_progress
last_updated: 2026-01-29
---

<current_state>
Debugging/fixing trait application and input display in Pipeline Output modal. Started as quick task 007 (add input/output tabs), evolved into discovering and fixing Phase 17 trait application bug.

Two issues found and fixed:
1. Traits connected via edges weren't being read by backend (only node.data.traitIds was checked)
2. Input tab only showed user message, not full system prompt with traits
</current_state>

<completed_work>

- Quick 007 original task: Add input/output tabs to OutputViewer - DONE (committed)
- Bug investigation: Found trait edge connections not being read by job-queue.server.ts
- Fix 1: Updated buildStepsFromFlow() to read traits from BOTH node.data.traitIds AND edge connections from trait nodes
- Fix 2: Updated pipeline-executor to store full input (system prompt + user message) in database
- Fix 3: Added stepInputs to SSE stream events and RunStreamState
- Fix 4: Updated RunProgress and pipelines.$id.tsx to use streamed inputs
- Removed debug logs
- Cleaned up unused runInputRef
- TypeScript compiles successfully
</completed_work>

<remaining_work>

- User needs to restart dev server and test the changes
- If working: commit all changes with appropriate message
- If not working: debug further
- Update STATE.md with quick task completion
</remaining_work>

<decisions_made>

- Store full input as formatted markdown with "## System Prompt" and "## User Input" sections for clarity
- Pass inputs through SSE stream rather than fetching from DB after completion (simpler, real-time)
- Read traits from both sources (node.data.traitIds for drop-on-agent, edges for trait-node connections) to support both UX patterns
</decisions_made>

<blockers>
None - waiting for user to test
</blockers>

<context>
Phase 17 added support for traits as standalone nodes connected via edges, but the backend only read from node.data.traitIds (the old drop-onto-agent method). The fix reads trait assignments from both sources.

The input display now shows everything sent to the LLM: system prompt (agent instructions + trait context) and user input.

Files modified:
- app/services/job-queue.server.ts - Read traits from edges
- app/services/pipeline-executor.server.ts - Store/emit full input
- app/services/run-emitter.server.ts - Add input to step_complete event
- app/components/pipeline-runner/use-run-stream.ts - Track stepInputs
- app/components/pipeline-runner/run-progress.tsx - Pass stepInputs to callback
- app/routes/pipelines.$id.tsx - Use stepInputs from stream
</context>

<next_action>
User should restart dev server, run a pipeline with a trait connected via edge, and verify:
1. Output sounds like the trait (e.g., pirate voice)
2. Input tab shows full system prompt including trait context

If working, commit with message like:
"fix: read pipeline traits from edge connections and show full input in output viewer"
</next_action>
