---
phase: quick-034
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routes/pipelines.$id.test.tsx
  - app/mocks/handlers.ts
autonomous: true
---

<objective>
Test the pipeline editor screen component (pipelines.$id.tsx) with comprehensive coverage for rendering states, user interactions, and integration with React Query hooks.

Purpose: Ensure the pipeline screen renders correctly across all states and user interactions work as expected.
Output: Complete test coverage for the pipeline editor screen component.
</objective>

<execution_context>
@/Users/brendan/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@app/routes/pipelines.$id.tsx
@app/routes/agents.test.tsx
@app/routes/traits.test.tsx
@app/mocks/handlers.ts
@app/test-utils.tsx
@.claude/skills/vitest-testing/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ensure mock handlers cover all pipeline screen dependencies</name>
  <files>app/mocks/handlers.ts</files>
  <action>
Verify and add any missing handlers needed for the pipeline screen. The screen uses:
- useAgents() - GET /api/agents (already exists)
- useTraits() - GET /api/traits (already exists)
- usePipeline(id) - GET /api/pipelines/:id (add if missing from plan 01)
- usePipelines() - GET /api/pipelines (add if missing from plan 01)
- useRunPipeline() - POST /api/pipeline/:id/run (add if missing from plan 02)

If any handlers are missing from previous plans, add them here. The pipeline screen needs all these endpoints to render without errors.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>All API endpoints used by pipeline screen have mock handlers</done>
</task>

<task type="auto">
  <name>Task 2: Create pipeline screen component tests</name>
  <files>app/routes/pipelines.$id.test.tsx</files>
  <action>
Create app/routes/pipelines.$id.test.tsx following the pattern from agents.test.tsx and traits.test.tsx:

1. Import testing utilities:
   - vitest (describe, test, expect, vi)
   - @testing-library/react (screen, waitFor)
   - userEvent from @testing-library/user-event
   - msw (http, HttpResponse)
   - ~/mocks/server
   - ~/test-utils (renderWithClient)
   - The component: import PipelineEditorPage from "./pipelines.$id"

2. Mock react-router hooks (the component uses useParams and useNavigate):
```typescript
vi.mock("react-router", async () => {
  const actual = await vi.importActual("react-router");
  return {
    ...actual,
    useParams: vi.fn(() => ({ id: "home" })),
    useNavigate: vi.fn(() => vi.fn()),
  };
});
```

3. Mock zustand stores (tab-store and pipeline-store):
```typescript
vi.mock("~/stores/tab-store", () => ({
  useTabStore: () => ({
    tabs: [],
    activeTabId: "home",
    closeTab: vi.fn(),
    focusOrOpenTab: vi.fn(),
  }),
  HOME_TAB_ID: "home",
}));

vi.mock("~/stores/pipeline-store", () => ({
  usePipelineStore: () => ({
    removePipeline: vi.fn(),
    getPipeline: vi.fn(),
  }),
}));
```

4. Mock @xyflow/react to avoid canvas issues in jsdom:
```typescript
vi.mock("@xyflow/react", () => ({
  ReactFlow: ({ children }: { children?: React.ReactNode }) => <div data-testid="react-flow">{children}</div>,
  ReactFlowProvider: ({ children }: { children: React.ReactNode }) => <>{children}</>,
  Background: () => null,
  Controls: () => null,
}));
```

5. Write tests:
   - "renders pipeline tabs component" - verify PipelineTabs area renders
   - "renders agent sidebar" - verify AgentSidebar renders with agents from query
   - "shows home tab empty state when id is home" - verify "Select a pipeline or create new" message
   - "handles loading state while fetching data" - delay handlers, check for expected UI
   - "handles error state when agents query fails" - override /api/agents to 500, verify graceful handling

6. Note: This is a complex component with many dependencies. Focus on:
   - Basic rendering without crashes
   - Integration with React Query (data flows from hooks to UI)
   - Key user-visible states

Use renderWithClient() for all renders. The component needs router context, so use withRouter: true option.
  </action>
  <verify>npm test -- pipelines.\$id.test.tsx passes all tests</verify>
  <done>Pipeline screen component tests pass, covering basic rendering and state handling</done>
</task>

</tasks>

<verification>
- npm run typecheck exits with code 0
- npm test -- pipelines.\$id.test.tsx shows all tests passing
- Tests cover rendering, loading, and error states
</verification>

<success_criteria>
- Pipeline screen has test file co-located with component
- Tests verify the component renders without crashing
- Tests verify React Query integration (data from hooks appears in UI)
- Complex dependencies (react-flow, zustand) are properly mocked
- All tests pass reliably
</success_criteria>

<output>
After completion, report: number of tests added, all passing, any issues encountered.
</output>
